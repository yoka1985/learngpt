<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nonviolent Communication Basics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&display=swap" rel="stylesheet">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-M27LTF4SQG"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      // Config will be called later after consent is given.
    </script>

    <style>
        :root {
            --green: #58cc02;
            --light-green: #89e219;
            --yellow: #ffc800;
            --blue: #1cb0f6;
            --light-blue: #88d4f8;
            --red: #ff4b4b;
            --light-red: #ff8989;
            --purple: #9b59b6;
            --border-radius: 16px;
            --button-height: 60px;

            /* Light Theme */
            --bg-primary: #f7f7f7;
            --bg-secondary: #ffffff;
            --text-primary: #4b4b4b;
            --text-secondary: #777777;
            --border-color: #e5e5e5;
            --shadow-color: #00000020;
        }
        
        body.dark-mode {
            /* Dark Theme */
            --bg-primary: #121212;
            --bg-secondary: #1E1E1E;
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --border-color: #333333;
            --shadow-color: #00000040;
        }


        *, *::before, *::after {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 1rem;
            overflow-y: auto;
            transition: background 0.3s, color 0.3s;
        }

        body.rtl { direction: rtl; }

        #app-wrapper {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
        }

        /* --- Header & Progress --- */
        header {
            width: 100%;
            padding: 1rem 0;
            margin-bottom: 1rem;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .xp-display, .lives-display {
            font-weight: 900;
            font-size: 1.2rem;
            color: var(--yellow);
            text-shadow: 1px 1px 2px #00000030;
        }
        .lives-display { color: var(--red); letter-spacing: 0.2em; }
        .header-left, .header-right { display: flex; align-items: center; gap: 1rem; }

        .sound-toggle, .theme-toggle, .lang-toggle {
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-secondary);
        }
        .lang-toggle.active { color: var(--blue); text-decoration: underline;}


        .progress-bar-container {
            width: 100%;
            height: 20px;
            background-color: var(--border-color);
            border-radius: 10px;
            border: 2px solid var(--border-color);
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--light-blue), var(--blue));
            border-radius: 8px;
            transition: width 0.5s ease-out;
        }
        
        .mini-map-container { display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; }
        .mini-map-group { display: flex; gap: 5px; padding: 4px; border: 1px solid var(--border-color); border-radius: 8px;}
        .mini-map-dot { width: 10px; height: 10px; border-radius: 50%; transition: background-color 0.3s; }
        .mini-map-dot.completed { background-color: var(--green); }
        .mini-map-dot.unlocked { background-color: var(--blue); animation: pulse 1.5s infinite; }
        .mini-map-dot.locked { background-color: var(--border-color); }
        .mini-map-dot.coming-soon { background-color: var(--purple); opacity: 0.5; }

        /* --- Main Content & Map --- */
        #content-area {
            flex-grow: 1;
            width: 100%;
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 24px #0000001a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 400px;
            transition: background 0.3s, border-color 0.3s;
        }

        .map-view {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
            padding: 2rem 0;
        }

        .stage-node { position: relative; }

        .stage-button {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 8px solid var(--bg-secondary);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1), 0 4px 0 var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s, color 0.3s;
            position: relative;
        }
        .stage-button:active {
            transform: translateY(2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1), 0 2px 0 var(--border-color);
        }

        .stage-icon-container { display: flex; align-items: center; justify-content: center; }
        .stage-icon { font-size: 2.5rem; }
        .level-indicator { font-size: 1.2rem; margin-left: 2px; }
        .stage-title-map { font-size: 0.8rem; margin-top: 5px; text-align: center; line-height: 1.2; }

        .stage-button.unlocked { background: var(--blue); color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1), 0 4px 0 #0d7ab3; animation: pulse 1.5s infinite; }
        .stage-button.completed { background: var(--green); color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1), 0 4px 0 #3a8a00; }
        .stage-button.locked { background: var(--border-color); color: var(--text-secondary); cursor: not-allowed; }
        .stage-button.coming-soon { background: var(--purple); color: white; cursor: not-allowed; opacity: 0.7; }
        
        .giraffe-map-icon { position: absolute; width: 60px; height: 60px; bottom: -30px; left: -50px; transform: rotate(-15deg); transition: all 0.5s ease-in-out; }
        body.rtl .giraffe-map-icon { left: auto; right: -50px; transform: rotate(15deg); }
        
        .level-title { width: 100%; text-align: center; font-size: 1.5rem; font-weight: 900; color: var(--text-secondary); padding-bottom: 1rem; margin-bottom: 2rem; border-bottom: 2px solid var(--border-color); }

        .screen-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 1.5rem; }
        .screen-title { font-size: 1.8rem; font-weight: 900; text-align: center; flex-grow: 1; margin: 0 2rem; }
        .back-to-menu-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); padding: 0.5rem; line-height: 1; }
        .completion-title { font-size: 1.8rem; font-weight: 900; text-align: center; margin-bottom: 1.5rem; }

        .completion-icon { font-size: 4rem; animation: bounce-in 0.5s ease-out; }
        .lesson-content, .exercise-question { font-size: 1.1rem; line-height: 1.6; text-align: center; margin-bottom: 2rem; }
        .lesson-example { width: 100%; padding: 1rem; background: var(--bg-primary); border-left: 5px solid var(--blue); border-radius: 8px; margin-top: 1.5rem; font-style: italic; transition: background 0.3s; }
        body.rtl .lesson-example { border-left: none; border-right: 5px solid var(--blue); }

        .btn { display: flex; align-items: center; justify-content: center; width: 100%; min-height: var(--button-height); font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 1.1rem; color: var(--text-primary); background-color: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: var(--border-radius); cursor: pointer; padding: 0.5rem 1rem; text-align: center; box-shadow: 0 4px 0 var(--shadow-color); transition: all 0.2s ease; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 0 var(--shadow-color); }
        .btn:active:not(:disabled) { transform: translateY(2px); box-shadow: 0 2px 0 var(--shadow-color); }
        .btn:disabled { cursor: not-allowed; color: var(--text-secondary); }
        .btn-primary { background-color: var(--green); color: white; border-color: var(--green); box-shadow: 0 4px 0 #3a8a00; }
        .btn-primary:hover:not(:disabled) { background-color: var(--light-green); border-color: var(--light-green); }
        .btn.correct { background-color: var(--green); border-color: var(--green); color: white; animation: bounce 0.5s; }
        .btn.incorrect { background-color: var(--light-red); border-color: var(--light-red); color: white; }
        
        footer { width: 100%; position: relative; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        
        .giraffe-container { display: flex; align-items: flex-end; gap: 10px; margin-top: 1rem; }
        #giraffe-svg-container { width: 80px; height: auto; flex-shrink: 0; display: flex; justify-content: center; align-items: flex-end; }
        .speech-bubble { position: relative; background: var(--bg-secondary); border-radius: var(--border-radius); padding: 1rem; font-weight: 700; box-shadow: 0 4px 0 var(--shadow-color); border: 1px solid var(--border-color); width: 100%; }
        .speech-bubble::before { content: ''; position: absolute; left: -10px; bottom: 15px; width: 0; height: 0; border: 10px solid transparent; border-right-color: var(--bg-secondary); border-left: 0; border-bottom: 0; margin-top: -5px; margin-left: -10px; transition: border-right-color 0.3s; }
        body.rtl .speech-bubble::before { left: auto; right: -10px; border-right-color: transparent; border-left-color: var(--bg-secondary); border-right: 0; border-left: 10px; margin-left: 0; margin-right: -10px; transition: border-left-color 0.3s; }
        
        #feedback-section { width: 100%; text-align: center; padding: 1rem; }
        .feedback-message { min-height: 80px; border-radius: var(--border-radius); padding: 1rem; margin-bottom: 1rem; font-weight: 700; font-size: 1.2rem; display: none; }
        .feedback-message.correct { display: block; background: #e1f9d3; color: #3a8a00; border-left: 5px solid var(--green); }
        .feedback-message.incorrect { display: block; background: #ffebee; color: #c00c00; border-left: 5px solid var(--red); }
        body.dark-mode .feedback-message.correct { background: #2c4a27; color: #b2d8b2; }
        body.dark-mode .feedback-message.incorrect { background: #5c2c2c; color: #f2c2c2; }
        body.rtl .feedback-message.correct, body.rtl .feedback-message.incorrect { border-left: none; border-right: 5px solid var(--green); }
        body.rtl .feedback-message.incorrect { border-right-color: var(--red); }
        #next-button-container { margin-top: 1rem; width: 100%; max-width: 300px; }

        .matching-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; width:100%; }
        .matching-pair { min-height: var(--button-height); display: flex; align-items: center; justify-content: center; padding: 0.75rem; background: var(--bg-secondary); transition: background 0.3s; border: 2px solid var(--border-color); border-radius: var(--border-radius); box-shadow: 0 4px 0 var(--shadow-color); cursor: grab; user-select: none; font-weight: 700; text-align: center; }
        .matching-pair.selected { background: var(--blue); color: white; border-color: var(--blue); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem;}
        .modal { background: var(--bg-secondary); padding: 2rem; border-radius: var(--border-radius); max-width: 90%; width: 400px; text-align: center; animation: bounce-in 0.4s; }
        .modal h3 { margin-top: 0; color: var(--blue); }
        .modal .btn { margin-top: 1rem; }
        .modal .selection-group { margin: 1.5rem 0; }
        .modal .selection-group p { font-weight: 700; margin-bottom: 0.5rem; }
        .modal .btn-group { display: flex; gap: 1rem; justify-content: center;}
        .modal .btn-group .btn { width: auto; padding: 0.5rem 1.5rem; }
        .modal .btn-group .btn.active { background-color: var(--blue); color: white; }
        #policy-text { text-align: left; max-height: 300px; overflow-y: auto; font-size: 0.9rem; }
        #policy-text a { color: var(--blue); }

        #cookie-consent-banner { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-secondary); padding: 1rem; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: none; align-items: center; justify-content: center; gap: 1rem; z-index: 2000; text-align: center; flex-wrap: wrap; }
        #cookie-consent-banner p { margin: 0 1rem 0.5rem 1rem; flex-basis: 100%; }
        #cookie-consent-banner .cookie-buttons { display: flex; gap: 1rem; }
        
        .footer-content { text-align: center; }
        .footer-links { margin-bottom: 1rem; }
        .footer-links a, .footer-links button { color: var(--text-secondary); text-decoration: none; margin: 0 0.5rem; font-size: 0.8rem; background: none; border: none; cursor: pointer; padding: 0; }
        .footer-links a:hover, .footer-links button:hover { text-decoration: underline; }
        .completion-actions { margin-top: 1.5rem; display: flex; flex-direction: column; align-items: center; gap: 1rem; width: 100%; max-width: 300px;}
        #reset-progress-btn { font-size: 0.8rem; color: var(--text-secondary); text-decoration: underline; background: none; border: none; cursor: pointer;}
        
        .poem-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; align-items: center; gap: 1.5rem; }
        .poem-image { width: 100%; height: auto; border-radius: var(--border-radius); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes bounce-in { 0% { transform: scale(0.7); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .confetti { position: fixed; top: -10px; width: 10px; height: 10px; opacity: 0.8; animation: fall 3s linear infinite; }
        @keyframes fall { to { transform: translateY(100vh); opacity: 0; } }
        
        @media (max-width: 600px) { body { padding: 0.5rem; } #content-area { padding: 1rem; } .screen-title { font-size: 1.5rem; } .lesson-content, .exercise-question { font-size: 1rem; } .btn { font-size: 1rem; } .matching-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="welcome-modal-overlay" class="modal-overlay">
        <div class="modal">
            <h3 id="welcome-title"></h3>
            <p id="welcome-text"></p>

            <div class="selection-group">
                 <p id="lang-select-label">Language</p>
                 <div class="btn-group">
                    <button id="lang-btn-en" class="btn active">English</button>
                    <button id="lang-btn-he" class="btn">注专转</button>
                 </div>
            </div>

            <button id="start-course-btn" class="btn btn-primary"></button>
        </div>
    </div>
    
    <div id="policy-modal-overlay" class="modal-overlay">
        <div class="modal">
            <h3 id="policy-title"></h3>
            <div id="policy-text"></div>
            <button id="close-policy-btn" class="btn btn-primary"></button>
        </div>
    </div>
    
    <div id="reset-confirm-modal-overlay" class="modal-overlay">
        <div class="modal">
            <h3 id="reset-confirm-title"></h3>
            <p id="reset-confirm-text"></p>
            <div class="btn-group">
                <button id="confirm-reset-btn" class="btn"></button>
                <button id="cancel-reset-btn" class="btn btn-primary"></button>
            </div>
        </div>
    </div>
   
    <div id="app-wrapper">
        <header>
            <div class="header-controls">
                <div class="header-left">
                     <div class="xp-display">わ 0</div>
                </div>
                <div class="header-right">
                    <div id="lives-display" class="lives-display"></div>
                    <button id="theme-toggle" class="theme-toggle"></button>
                    <button id="sound-toggle" class="sound-toggle"></button>
                </div>
            </div>
            <div class="progress-bar-container">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
            <div id="mini-map-container" class="mini-map-container"></div>
        </header>

        <main id="content-area"></main>

        <footer>
            <div class="footer-content">
                <div class="footer-links">
                    <a href="#" id="support-link" target="_blank"></a>
                    <a href="#" id="terms-link"></a>
                    <a href="#" id="privacy-link"></a>
                </div>
                <div class="giraffe-container">
                    <div id="giraffe-svg-container">
                        <!-- Giraffe SVG will be injected here by JavaScript -->
                    </div>
                    <div id="giraffe-speech" class="speech-bubble"></div>
                </div>
            </div>
        </footer>
    </div>
    
    <div id="cookie-consent-banner">
        <p id="cookie-text"></p>
        <div class="cookie-buttons">
            <button id="accept-cookies-btn" class="btn btn-primary"></button>
            <button id="decline-cookies-btn" class="btn"></button>
        </div>
    </div>
    
    <script>
        const contentArea = document.getElementById('content-area');
        const progressBar = document.getElementById('progress-bar');
        const xpDisplay = document.querySelector('.xp-display');
        const livesDisplay = document.getElementById('lives-display');
        const soundToggle = document.getElementById('sound-toggle');
        const themeToggle = document.getElementById('theme-toggle');
        const giraffeSpeech = document.getElementById('giraffe-speech');
        const giraffeSvgContainer = document.getElementById('giraffe-svg-container');
        
        // Modal elements
        const welcomeModalOverlay = document.getElementById('welcome-modal-overlay');
        const welcomeTitle = document.getElementById('welcome-title');
        const welcomeText = document.getElementById('welcome-text');
        const langSelectLabel = document.getElementById('lang-select-label');
        const langBtnEn = document.getElementById('lang-btn-en');
        const langBtnHe = document.getElementById('lang-btn-he');
        const startCourseBtn = document.getElementById('start-course-btn');

        // Policy Modal
        const policyModalOverlay = document.getElementById('policy-modal-overlay');
        const policyTitle = document.getElementById('policy-title');
        const policyText = document.getElementById('policy-text');
        const closePolicyBtn = document.getElementById('close-policy-btn');

        // Reset Confirm Modal
        const resetConfirmModalOverlay = document.getElementById('reset-confirm-modal-overlay');
        const resetConfirmTitle = document.getElementById('reset-confirm-title');
        const resetConfirmText = document.getElementById('reset-confirm-text');
        const confirmResetBtn = document.getElementById('confirm-reset-btn');
        const cancelResetBtn = document.getElementById('cancel-reset-btn');

        // Cookie Banner
        const cookieBanner = document.getElementById('cookie-consent-banner');
        const cookieText = document.getElementById('cookie-text');
        const acceptCookiesBtn = document.getElementById('accept-cookies-btn');
        const declineCookiesBtn = document.getElementById('decline-cookies-btn');

        // Footer Links
        const supportLink = document.getElementById('support-link');
        const termsLink = document.getElementById('terms-link');
        const privacyLink = document.getElementById('privacy-link');

        // --- Giraffe SVGs representing growth ---
        const giraffeSVGs = [
            // Stage 0: Baby
            `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M58 83C58 88.5228 54.5228 93 50 93C45.4772 93 42 88.5228 42 83C42 77.4772 45.4772 73 50 73C54.5228 73 58 77.4772 58 83Z" fill="#FBBF24"/><path d="M45 52C45 50.3431 46.3431 49 48 49H52C53.6569 49 55 50.3431 55 52V73H45V52Z" fill="#FCD34D"/><path d="M51.5 39C51.5 35.6863 48.8137 33 45.5 33C42.1863 33 39.5 35.6863 39.5 39V50H51.5V39Z" fill="#FCD34D"/><circle cx="43" cy="40" r="2" fill="black"/><path d="M41 33C41 31.8954 41.8954 31 43 31H44C45.1046 31 46 31.8954 46 33V35H41V33Z" fill="#D97706"/><path d="M49 33C49 31.8954 49.8954 31 51 31H52C53.1046 31 54 31.8954 54 33V35H49V33Z" fill="#D97706"/><circle cx="47" cy="60" r="3" fill="#F59E0B"/><circle cx="53" cy="77" r="4" fill="#F59E0B"/></svg>`,
            // Stage 1: Toddler
            `<svg viewBox="0 0 100 110" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M60 90C60 95.5228 56.5228 100 52 100C47.4772 100 44 95.5228 44 90C44 84.4772 47.4772 80 52 80C56.5228 80 60 84.4772 60 90Z" fill="#FBBF24"/><path d="M47 50C47 48.3431 48.3431 47 50 47H54C55.6569 47 57 48.3431 57 50V80H47V50Z" fill="#FCD34D"/><path d="M53.5 32C53.5 28.6863 50.8137 26 47.5 26C44.1863 26 41.5 28.6863 41.5 32V48H53.5V32Z" fill="#FCD34D"/><circle cx="45" cy="33" r="2" fill="black"/><path d="M43 26C43 24.8954 43.8954 24 45 24H46C47.1046 24 48 24.8954 48 26V28H43V26Z" fill="#D97706"/><path d="M51 26C51 24.8954 51.8954 24 53 24H54C55.1046 24 56 24.8954 56 26V28H51V26Z" fill="#D97706"/><circle cx="49" cy="65" r="3.5" fill="#F59E0B"/><circle cx="55" cy="84" r="4.5" fill="#F59E0B"/><circle cx="49" cy="93" r="3" fill="#F59E0B"/></svg>`,
            // Stage 2: Youth
            `<svg viewBox="0 0 100 120" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M62 97C62 102.523 58.5228 107 54 107C49.4772 107 46 102.523 46 97C46 91.4772 49.4772 87 54 87C58.5228 87 62 91.4772 62 97Z" fill="#FBBF24"/><path d="M49 48C49 46.3431 50.3431 45 52 45H56C57.6569 45 59 46.3431 59 48V87H49V48Z" fill="#FCD34D"/><path d="M55.5 25C55.5 21.6863 52.8137 19 49.5 19C46.1863 19 43.5 21.6863 43.5 25V46H55.5V25Z" fill="#FCD34D"/><circle cx="47" cy="26" r="2" fill="black"/><path d="M45 19C45 17.8954 45.8954 17 47 17H48C49.1046 17 50 17.8954 50 19V21H45V19Z" fill="#D97706"/><path d="M53 19C53 17.8954 53.8954 17 55 17H56C57.1046 17 58 17.8954 58 19V21H53V19Z" fill="#D97706"/><circle cx="51" cy="70" r="4" fill="#F59E0B"/><circle cx="57" cy="91" r="5" fill="#F59E0B"/><circle cx="51" cy="55" r="3" fill="#F59E0B"/></svg>`,
             // Stage 3 & 4: Teen / Adult
            `<svg viewBox="0 0 100 130" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M64 104C64 109.523 60.5228 114 56 114C51.4772 114 48 109.523 48 104C48 98.4772 51.4772 94 56 94C60.5228 94 64 98.4772 64 104Z" fill="#FBBF24"/><path d="M51 46C51 44.3431 52.3431 43 54 43H58C59.6569 43 61 44.3431 61 46V94H51V46Z" fill="#FCD34D"/><path d="M57.5 18C57.5 14.6863 54.8137 12 51.5 12C48.1863 12 45.5 14.6863 45.5 18V44H57.5V18Z" fill="#FCD34D"/><circle cx="49" cy="19" r="2" fill="black"/><path d="M47 12C47 10.8954 47.8954 10 49 10H50C51.1046 10 52 10.8954 52 12V14H47V12Z" fill="#D97706"/><path d="M55 12C55 10.8954 55.8954 10 57 10H58C59.1046 10 60 10.8954 60 12V14H55V12Z" fill="#D97706"/><circle cx="53" cy="75" r="4" fill="#F59E0B"/><circle cx="59"cy="98" r="5" fill="#F59E0B"/><circle cx="53" cy="58" r="3.5" fill="#F59E0B"/><circle cx="58" cy="108" r="3" fill="#F59E0B"/></svg>`
        ];

        let audioCtx;
        function initAudio() { if (!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch (e) { console.error("Web Audio API not supported."); } } }
        function playSound(type) {
            if (!audioCtx || state.isMuted) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            if (type === 'correct') { o.type = 'sine'; o.frequency.setValueAtTime(600, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1); g.gain.setValueAtTime(0.2, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.2); o.start(); o.stop(audioCtx.currentTime + 0.2); }
            else if (type === 'incorrect') { o.type = 'square'; o.frequency.setValueAtTime(200, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2); g.gain.setValueAtTime(0.2, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.3); o.start(); o.stop(audioCtx.currentTime + 0.3); }
            else if (type === 'streak' || type === 'moduleComplete') { const notes = type === 'streak' ? [600, 750, 900] : [523, 659, 783, 1046]; g.gain.setValueAtTime(0.15, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5); notes.forEach((n, i) => { const o2 = audioCtx.createOscillator(); o2.connect(g); o2.type = 'triangle'; o2.frequency.setValueAtTime(n, audioCtx.currentTime + i * 0.1); o2.start(audioCtx.currentTime + i * 0.1); o2.stop(audioCtx.currentTime + i * 0.1 + 0.1); }); }
        }

        let state = {};
        const defaultState = {
            view: 'map',
            lang: 'he', // Default to Hebrew
            theme: 'light',
            activeModule: { id: null, screen: 0, lives: 3, completedExercises: [] },
            xp: 0,
            streak: 0,
            isMuted: false,
            completedModules: []
        };
        
        const courseContent = {
            en: {
                welcomeTitle: "Welcome to Compassionate Communication!",
                welcomeText: "Join me on a journey to learn Nonviolent Communication (NVC). We'll learn to connect more deeply with ourselves and others.",
                langSelectLabel: "Language",
                letsGo: "Let's Begin ",
                gotIt: "Got it!",
                mapSpeech: "Wonderful! When you're ready, select the next step on our path.",
                stageSpeech: "Let's look at this together.",
                moduleComplete: "Step Complete!",
                outOfTries: "It's okay to stumble.",
                outOfTriesMsg: "That was tricky! Every attempt is a chance to learn. Let's try this step again from the beginning.",
                tryAgain: "Try Again",
                continue: "Continue",
                continueToMap: "Continue to Map",
                backToMenu: "Back to Menu",
                empathyTitle: "Empathy In Action",
                finalTitle: "You've learned the core path! ",
                finalContent: "Congratulations! You've walked through the four steps of NVC. You now have the tools to express yourself honestly and listen with compassion. This is a lifelong practice.",
                finalBot: "Your heart is speaking so clearly! ",
                feedbackCTA: "Give Feedback & Get Updates",
                supportProject: "Support this project",
                terms: "Terms of Use",
                privacy: "Privacy Policy",
                resetProgress: "Reset Progress",
                cookieText: "We use cookies to improve your experience and analyze site traffic.",
                accept: "Accept",
                decline: "Decline",
                close: "Close",
                resetConfirmTitle: "Are you sure?",
                resetConfirmText: "This will permanently delete all your progress.",
                confirmReset: "Yes, Reset",
                cancel: "Cancel",
                comingSoon: "Coming soon: Content for children and parents!",
                supportCTA: "If you found value in this journey, your support helps this project grow. Any amount is greatly appreciated.",
            },
            he: {
                welcomeTitle: "专  转拽砖专转 拽专转!",
                welcomeText: "爪专驻  住注  转拽砖专转 拽专转 (NVC).  转专 注爪 专 驻 注拽 转专.",
                langSelectLabel: "砖驻",
                letsGo: " 转 ",
                gotIt: "转!",
                mapSpeech: "专! 砖转 , 专 转 爪注  专.",
                stageSpeech: "  转  .",
                moduleComplete: "砖 砖!",
                outOfTries: " 住专 注.",
                outOfTriesMsg: "  转专!  住  转 .  住 转 砖  砖 转.",
                tryAgain: "住转 砖",
                continue: "砖",
                continueToMap: "砖 驻",
                backToMenu: "专 转驻专",
                empathyTitle: "驻转 驻注",
                finalTitle: "转 转 砖 ! ",
                finalContent: " ! 注专转 专 专注转 爪注 砖 转拽砖专转 拽专转. 注转 砖   注 转 注爪 转 拽砖 .  专 .",
                finalBot: " 砖 专   专专! ",
                feedbackCTA: "转 砖 拽转 注",
                supportProject: "转 驻专拽",
                terms: "转 砖砖",
                privacy: "转 驻专转",
                resetProgress: "驻住 转拽转",
                cookieText: " 砖转砖 注转 (cookies)  砖驻专 转 转 砖转砖 转 转 转注专转 转专.",
                accept: "砖专",
                decline: "住专",
                close: "住专",
                resetConfirmTitle: " 转 ?",
                resetConfirmText: "驻注  转拽 转  转拽转 砖 爪转转.",
                confirmReset: ", 驻住",
                cancel: "",
                comingSoon: "拽专: 转 专 !",
                supportCTA: " 爪转 注专 住注 , 转转 转注专 驻专拽 爪.  住 转拽 专.",
            }
        };

        const modules = [
            // Observations
            { id: 1, parent: {en: 'Observations', he: '转'}, level: 1, icon: "", title: {en: 'Basics', he: '住转'}, screens: [
                { type: 'lesson', title: {en: "Meet the Giraffe", he: "专 转 '专祝"}, content: { en: "In NVC, the giraffe symbolizes compassionate communication. It has a long neck to see from a clear perspective and a big heart. I'll be your guide!", he: "转拽砖专转 拽专转, '专祝 住 转拽砖专转 转. 砖  爪专 专  专转 驻专住驻拽 专  .   专 砖!" } },
                { type: 'lesson', title: {en: 'Observation vs. Evaluation', he: '  注专'}, content: {en: "The first step is to observe what is actually happening, free of judgment. We state facts, like a camera.", he: "爪注 专砖    砖拽专 驻注,  砖驻.  爪 注转,   爪."}, example: {en: "Evaluation: 'You're so messy.'\nObservation: 'I see socks on the floor.'", he: "注专: '转   .'\n: ' 专 专 注 专爪驻.'"} },
                { type: 'exercise', subType: 'ab-test', question: {en:"Which is an observation?", he: " 专  ?"}, options: [{text: {en:'You never listen.', he: '转 祝 驻注  拽砖.'}, correct: false}, {text: {en:'You were looking at your phone while I was talking.', he: '住转转 驻 砖 砖专转.'}, correct: true}], feedback: {correct: {en:"Exactly! That describes a specific action without judgment.", he: "拽!  转专 驻注 住驻爪驻转  砖驻."}, incorrect: {en:"'Never' is an evaluation. The other option states what was seen.", he: "'祝 驻注'  注专. 驻砖专转 砖 爪转  砖专."}} },
                { type: 'exercise', subType: 'ab-test', question: {en:"Which is an evaluation?", he: " 专  注专?"}, options: [{text: {en:"The music is playing at 80 decibels.", he: "拽 转转 注爪 砖 80 爪."}, correct: false}, {text: {en:'The music is too loud.', he: '拽 专注砖转 .'}, correct: true}], feedback: {correct: {en:"Yes, 'too loud' is a subjective judgment.", he: ", '专注砖转 '  砖驻 住拽."}, incorrect: {en:"Measuring decibels is a factual observation.", he: "转 爪   注转转."}} },
                { type: 'exercise', subType: 'mcq', question: {en:"'He is a good soccer player.' Is this an observation or evaluation?", he: "' 砖拽 专 '.     注专?"}, options: [{text: {en:'Observation', he: ''}, correct: false}, {text: {en:'Evaluation', he: '注专'}, correct: true}], feedback: {correct: {en:"Correct. 'Good' is an evaluation. An observation would be 'He scored three goals.'", he: ". ''  注专.  转 ' 拽注 砖砖 砖注专'."}, incorrect: {en:"'Good' is a judgment, not a neutral fact.", he: "''  砖驻,  注 专转."}} },
                { type: 'exercise', subType: 'ab-test', question: {en:"Which is an observation?", he: " 专  ?"}, options: [{text: {en:"She is procrastinating.", he: "  专."}, correct: false}, {text: {en:"She said she would finish the report yesterday, and I see it is not in my inbox.", he: " 专 砖转住 转  转,  专 砖  转转 专 住 砖."}, correct: true}], feedback: {correct: {en:"That's it. It states the facts without interpreting them as 'procrastinating'.", he: " . 专 爪转 转 注转  驻专砖 转 '转'."}, incorrect: {en:"'Procrastinating' is a label, an evaluation of behavior.", he: "'转'  转转, 注专 砖 转转."}} },
                { type: 'exercise', subType: 'mcq', question: {en:"What is the main goal of sharing an observation first?", he: " 专 注拽专转 砖 砖转祝  转?"}, options: [{text: {en:"To prove you are right.", he: " 砖转 爪拽."}, correct: false}, {text: {en:"To create a shared reality with the other person.", he: "爪专 爪转 砖转驻转 注  专."}, correct: true}, {text: {en:"To show them what they did wrong.", he: "专转    注砖  住专."}, correct: false}], feedback: {correct: {en:"Exactly! Starting with a neutral, shared fact makes it easier for others to listen.", he: "拽! 转 注 注 专转 砖转驻转 拽 注 专 拽砖."}, incorrect: {en:"The goal is connection, not being right. Starting with a neutral fact helps build that connection.", he: "专  专,  转 爪拽. 转 注 注 专转 注专转 转 转 专 ."}} },
            ]},
            { id: 2, parent: {en: 'Observations', he: '转'}, level: 2, icon: "", title: {en: 'Basics+', he: '住转+'}, screens: [
                { type: 'lesson', title: {en: 'Avoiding Generalizations', he: '注转 转'}, content: {en: "Words like 'always,' 'never,' 'often,' or 'seldom' usually signal an evaluation disguised as an observation.", he: "  '转', '祝 驻注', '注转 拽专转'  '驻注' 专  住转 注专 驻砖转 ."}, example: {en:"Evaluation: 'You are always late.'\nObservation: 'The last three times we met, you arrived after our agreed time.'", he:"注专: '转 转 专.'\n: '砖砖 驻注 专转 砖驻砖, 注转 专 砖注 砖拽注.'"} },
                { type: 'exercise', subType: 'mcq', question: {en:"Which word signals an evaluation?", he: "  住转 注专?"}, options: [{text: {en:'always', he: '转'}, correct: true}, {text: {en:'saw', he: '专转'}, correct: false}, {text: {en:'heard', he: '砖注转'}, correct: false}], feedback: {correct: {en:"Correct! Generalizations like 'always' are evaluations.", he: "! 转  '转'  注专转."}, incorrect: {en:"'Saw' and 'heard' point to direct observations.", he: "'专转' '砖注转' 爪注转 注 转 砖专转."}} },
                { type: 'exercise', subType: 'matching', question: {en: "Match the statement to its type.", he: "转 转 专 住 砖."}, pairs: [{item1: {en: "He is generous.", he: " ."}, item2: {en: "Evaluation", he: "注专"}}, {item1: {en: "She arrived at 9:05.", he: " 注 -9:05."}, item2: {en: "Observation", he: ""}}, {item1: {en: "You work too much.", he: "转 注 转专 ."}, item2: {en: "Evaluation", he: "注专"}}], feedback: {correct: {en: "Great job distinguishing between what you see and what you think about it!", he: "注 专转    砖转 专   砖转 砖 注 !"}, incorrect: {en: "Let's try again. An observation is just the facts, an evaluation adds a judgment.", he: " 住 砖.   专拽 注转, 注专 住驻 砖驻."}} },
                { type: 'lesson', title: {en: 'Quotes as Observations', he: '爪 转'}, content: {en: "Quoting someone directly is a very powerful form of observation. It removes interpretation.", he: "爪 砖 砖专转  爪专 拽  砖 .  住专 驻专砖转."}, example: {en:"Interpretation: 'He was angry.'\nObservation: 'He said, \"I am so frustrated right now!\" in a loud voice.'", he:"驻专砖转: ' 注住.'\n: ' 专, \"   转住 注砖!\" 拽 专.'"} },
                { type: 'exercise', subType: 'ab-test', question: {en:"Which is a better observation?", he: "   转专?"}, options: [{text: {en:'You were rude.', he: '转 住 专.'}, correct: false}, {text: {en:"You said 'That's a stupid idea.'", he: '专转 " 专注 驻砖".'}, correct: true}], feedback: {correct: {en:"Exactly. Quoting is precise.", he: "拽. 爪  拽."}, incorrect: {en:"'Rude' is a judgment. Quoting the exact words is an observation.", he: "'住 专'  砖驻. 爪  拽转  ."}} },
                { type: 'exercise', subType: 'ab-test', question: {en:"Which observation is free of prediction?", he: "  转 ?"}, options: [{text: {en:"If you don't study, you will fail the test.", he: "  转, 转砖 ."}, correct: false}, {text: {en:"I see you haven't opened the book today.", he: " 专 砖 驻转转 转 住驻专 ."}, correct: true}], feedback: {correct: {en:"Correct. Predicting the future is an evaluation, not an observation of the present.", he: ".  注转  注专,   砖 ."}, incorrect: {en:"'You will fail' is a prediction, which is a type of evaluation.", he: "'转砖'  , 砖 住 砖 注专."}} },
            ]},
            { id: 3, parent: {en: 'Observations', he: '转'}, level: 3, icon: "", title: {en: 'Advanced', he: '转拽'}, screens: [
                { type: 'lesson', title: {en: 'Subtle Evaluations', he: '注专转 注转'}, content: {en: "Sometimes evaluations hide in seemingly innocent words. Adjectives like 'good,' 'bad,' 'beautiful,' or 'ugly' are almost always evaluations.", he: "驻注 注专转 住转转专转  转转 专. 砖转 转专  '', '专注', '驻'  '注专'  注 转 注专转."} },
                { type: 'exercise', subType: 'mcq', question: {en:"'That painting is beautiful.' Observation or evaluation?", he: "'爪专  驻.'   注专?"}, options: [{text: {en:'Observation', he: ''}, correct: false}, {text: {en:'Evaluation', he: '注专'}, correct: true}], feedback: {correct: {en:"Correct. Beauty is in the eye of the beholder. An observation might be 'The painting has blue and yellow colors.'", he: ". 驻  注 转.   转 '爪专 砖 爪注  爪'."}, incorrect: {en:"'Beautiful' is a personal judgment, not a verifiable fact.", he: "'驻'  砖驻 砖,  注 砖转 转."}} },
                { type: 'exercise', subType: 'ab-test', question: {en:"Which statement is more likely to create connection?", he: " 专 爪驻 转专 爪专 专?"}, options: [{text: {en:"You're wrong.", he: "转 注."}, correct: false}, {text: {en:"I see it differently.", he: " 专 转  专转."}, correct: true}], feedback: {correct: {en:"Yes. 'I see it differently' is an observation of your own perspective, while 'You're wrong' is a direct evaluation of the other person.", he: ". ' 专 转  专转'   砖 驻专住驻拽 砖, 注 砖'转 注'  注专 砖专 砖  专."}, incorrect: {en:"'You're wrong' is a classic evaluation that often leads to defensiveness.", he: "'转 注'  注专 拽住转 砖注转 拽专转  转转."}} },
                { type: 'lesson', title: {en: "Observing Without a 'Why'", he: "  ''"}, content: {en: "A pure observation describes the 'what,' not the 'why.' Guessing someone's motivation ('You did that to annoy me') is an evaluation.", he: " 专 转专转 转 '',  转 ''. 砖 注 砖 砖 ('注砖转 转   注爪 转')  注专."}, example: {en: "Evaluation: 'You left the door open to let the cat out.'\nObservation: 'I see the door is open.'", he: "注专: '砖专转 转 转 驻转  砖转 爪.'\n: ' 专 砖转 驻转.'"} },
                { type: 'exercise', subType: 'mcq', question: {en:"'You're just trying to get attention.' This is an:", he: "'转 专拽 住 砖 转砖转 .' :"}, options: [{text: {en:'Observation of intent', he: ' 砖 '}, correct: false}, {text: {en:'Evaluation of intent', he: '注专 砖 '}, correct: true}], feedback: {correct: {en:"Exactly. We can't observe intent, we can only guess it. Guessing is a form of evaluation.", he: "拽.     ,   专拽 砖 转. 砖  住 砖 注专."}, incorrect: {en:"We can't truly observe someone's intent, so stating it as a fact is an evaluation.", he: "  转    砖 砖,  爪转 注  注专."}} },
                { type: 'exercise', subType: 'ab-test', question: {en:"Which is a pure observation?", he: " 专   专?"}, options: [{text: {en:"I noticed you raised your voice.", he: "砖转  砖专转 转 拽."}, correct: true}, {text: {en:"I noticed you were getting angry.", he: "砖转  砖转转 注住."}, correct: false}], feedback: {correct: {en:"Perfect. 'Raised your voice' is a verifiable action. 'Getting angry' is an interpretation of an internal state.", he: "砖. '专转 转 拽'  驻注 砖转 转. '转 注住'  驻专砖转 爪 驻."}, incorrect: {en:"'Getting angry' is an interpretation of someone else's feeling. The observation is the action you saw or heard.", he: "'转 注住'  驻专砖转 专砖 砖 砖 专.   驻注 砖专转  砖注转."}} },
            ], poemImage: "G1.jpg"},
            // Feelings
            { id: 4, parent: {en: 'Feelings', he: '专砖转'}, level: 1, icon: "わ", title: {en: 'Basics', he: '住转'}, screens: [
                { type: 'lesson', title: {en: 'Identifying Feelings', he: ' 专砖转'}, content: {en: "The second step is to notice the feelings that arise from our observation. These are emotions within us, not thoughts about others.", he: "爪注 砖  砖  专砖转 砖注  砖.   专砖转 转,  砖转 注 专."}, example: {en: "Thought disguised as feeling: 'I feel like you don't care.'\nPure feeling: 'I feel sad.'", he: "砖 驻砖转 专砖: ' 专砖/ 砖 驻转 .'\n专砖 专: ' 注爪/.'"} },
                { type: 'exercise', subType: 'mcq', question: {en: "Which of these is a pure feeling?", he: "   专砖 专?"}, options: [{text: {en: 'I feel misunderstood.', he: ' 专砖/  /转.'}, correct: false}, {text: {en: 'I feel pain.', he: ' 砖/ .'}, correct: true}, {text: {en: 'I feel that you should know better.', he: ' 专砖/ 砖转 爪专/ 注转 转专 .'}, correct: false}], feedback: {correct: {en: "Yes, 'pain' is a direct feeling. 'Misunderstood' describes a thought about what someone else is thinking.", he: ", ''  专砖 砖专. ' ' 转专 砖 注  砖专 砖."}, incorrect: {en: "'Pain' is a pure feeling. 'Misunderstood' is a thought about how someone else sees you.", he: "''  专砖 专. ' '  砖 注  砖 专 专 转."}} },
                { type: 'exercise', subType: 'mcq', question: {en: "Which is a feeling?", he: "   专砖?"}, options: [{text: {en: 'Happy', he: '砖'}, correct: true}, {text: {en: 'Abandoned', he: '砖'}, correct: false}, {text: {en: 'Good', he: ''}, correct: false}], feedback: {correct: {en: "Yes, 'happy' is a core feeling.", he: ", '砖'  专砖 ."}, incorrect: {en: "'Abandoned' is an interpretation of an action. 'Good' is an evaluation.", he: "'砖'  驻专砖转 砖 驻注. ''  注专."}} },
                { type: 'exercise', subType: 'ab-test', question: {en: "Which statement expresses a pure feeling?", he: " 专 转 专砖 专?"}, options: [{text: {en: 'I feel manipulated.', he: ' 专砖/ 爪/转.'}, correct: false}, {text: {en: 'I am disappointed.', he: ' /转.'}, correct: true}], feedback: {correct: {en: "Correct. 'Disappointed' describes your internal experience. 'Manipulated' describes your interpretation of another's actions.", he: ". '/转' 转专 转  驻转 砖. '爪/转' 转专 转 驻专砖转 砖 驻注转 砖 专."}, incorrect: {en: "'Manipulated' is an interpretation of someone's actions. 'Disappointed' is a pure feeling.", he: "'爪/转'  驻专砖转 驻注转 砖 砖 专. '/转'  专砖 专."}} },
                { type: 'exercise', subType: 'ab-test', question: {en: "Which feeling arises when our needs ARE MET?", he: " 专砖 注 砖专 爪专 砖 转?"}, options: [{text: {en: 'Peaceful', he: '砖'}, correct: true}, {text: {en: 'Anxious', he: '专'}, correct: false}], feedback: {correct: {en: "Yes, feelings like 'peaceful', 'happy', and 'joyful' tell us our needs are being met.", he: ", 专砖转  '砖', '砖' '砖专' 专  砖爪专 砖 转."}, incorrect: {en: "'Anxious' points to an unmet need, perhaps for safety or clarity. 'Peaceful' signals met needs.", he: "'专' 爪注 注 爪专 砖 转,    专转. '砖' 住转 爪专 砖."}} },
                { type: 'exercise', subType: 'mcq', question: {en: "Which of these is a feeling, not a thought?", he: "   专砖,  砖?"}, options: [{text: {en: 'I feel like leaving.', he: '  转.'}, correct: false}, {text: {en: 'I feel tired.', he: ' 注祝/.'}, correct: true}, {text: {en: 'I feel you are right.', he: ' 专砖/ 砖转/ 爪拽/转.'}, correct: false}], feedback: {correct: {en: "Correct. 'Tired' describes a physical and emotional state.", he: ". '注祝/' 转专/转 爪 驻 专砖."}, incorrect: {en: "'Feeling like...' or 'feeling that...' usually introduce thoughts, not feelings.", he: "' ...'  ' 专砖/ 砖...' 专  爪 砖转,  专砖转."}} },
            ]},
            { id: 5, parent: {en: 'Feelings', he: '专砖转'}, level: 2, icon: "わ", title: {en: 'Basics+', he: '住转+'}, screens: [
                { type: 'lesson', title: {en: 'Feelings vs. Faux Feelings', he: "专砖转  '专砖转 '"}, content: {en: "Words like 'attacked,' 'abandoned,' or 'betrayed' often imply that someone else did something *to* us. They are thoughts about others' actions, not pure feelings.", he: "  '转拽祝', '砖'  '' 专 专转 砖砖 专 注砖  砖.  砖转 注 驻注转 砖 专,  专砖转 专."}, example: {en: "Faux feeling: 'I feel rejected.'\nPure feeling behind it: 'I feel lonely,' or 'I feel scared.'", he: "专砖 : ' 专砖/ /.'\n专砖 专 专: ' /,'  ' 驻/转.'"} },
                { type: 'exercise', subType: 'mcq', question: {en: "Which of these is a 'faux feeling' (a thought about an action)?", he: "   '专砖 ' (砖 注 驻注)?"}, options: [{text: {en: 'Sad', he: '注爪'}, correct: false}, {text: {en: 'Ignored', he: '转注转'}, correct: true}, {text: {en: 'Joyful', he: '砖'}, correct: false}], feedback: {correct: {en: "Correct. 'Ignored' implies someone did something to you. The feeling behind it might be 'loneliness' or 'sadness'.", he: ". '转注转' 专转 砖砖 注砖  砖. 专砖 专  注砖 转 '转'  '注爪'."}, incorrect: {en: "'Sad' and 'joyful' are pure feelings. 'Ignored' is an interpretation of someone else's action.", he: "'注爪' '砖'  专砖转 专. '转注转'  驻专砖转 驻注 砖 砖 专."}} },
                { type: 'exercise', subType: 'matching', question: {en: "Match the 'faux feeling' to a possible pure feeling.", he: "转 转 '专砖 ' 专砖 专 驻砖专."}, pairs: [{item1: {en: 'I feel judged', he: ' 专砖/ 砖驻/转'}, item2: {en: 'I feel anxious', he: ' 砖/ 专'}}, {item1: {en: 'I feel unheard', he: ' 专砖/ 砖 砖注 转'}, item2: {en: 'I feel frustrated', he: ' 转住/转'}}, {item1: {en: 'I feel attacked', he: ' 专砖/ 转拽祝/转'}, item2: {en: 'I feel scared', he: ' 驻/转'}}], feedback: {correct: {en: "Excellent! You're seeing past the thought to the real feeling underneath.", he: "爪! 转 专 注专 砖  专砖 转 砖转转."}, incorrect: {en: "Try again. What might you be feeling inside when you think someone is judging you?", he: "住 砖.  转 注砖 专砖 驻 砖转 砖 砖砖 砖驻 转?"}} },
                { type: 'lesson', title: {en: 'Taking Responsibility', he: '拽转 专转'}, content: {en: "Instead of saying 'You make me angry,' NVC encourages 'I feel angry when...'. This takes responsibility for our own feelings, which are generated by our needs, not by others' actions.", he: "拽 专 '转/ 注住/ 转', 转拽砖专转 拽专转 注转 ' 注住/转 砖...'.  拽 专转 注 专砖转 砖, 砖爪专 爪专 砖,  驻注转 砖 专."} },
                { type: 'exercise', subType: 'ab-test', question: {en: "Which statement takes responsibility for the feeling?", he: " 专 拽转 专转 注 专砖?"}, options: [{text: {en: "You're annoying me.", he: "转/ 注爪/转 转."}, correct: false}, {text: {en: "I feel annoyed when I hear that.", he: " 专砖/ 注爪转 砖 砖注/转 转 ."}, correct: true}], feedback: {correct: {en: "Yes. This phrasing owns the feeling ('I feel annoyed') instead of blaming the other person.", he: ". 住  拽 注转 注 专砖 (' 专砖/ 注爪转') 拽 砖 转  专."}, incorrect: {en: "'You're annoying me' places the cause of the feeling on the other person.", he: "'转/ 注爪/转 转'  转 住 专砖 爪  专."}} },
                { type: 'exercise', subType: 'mcq', question: {en: "According to NVC, what is the true source of our feelings?", he: "驻 转拽砖专转 拽专转,  拽专 转 砖 专砖转 砖?"}, options: [{text: {en: "Other people's actions", he: "驻注转 砖 砖 专"}, correct: false}, {text: {en: "Our met or unmet needs", he: "爪专 砖 砖   "}, correct: true}, {text: {en: "The situation we are in", he: "爪   爪"}, correct: false}], feedback: {correct: {en: "Exactly. Our feelings are signals about our needs.", he: "拽. 专砖转 砖  转转  爪专 砖."}, incorrect: {en: "While actions and situations are triggers, NVC teaches that the root cause of feelings lies in our needs.", he: "注 砖驻注转 爪  专专, 转拽砖专转 拽专转 转 砖砖专砖 专砖转  爪专 砖."}} },
            ]},
            { id: 6, parent: {en: 'Feelings', he: '专砖转'}, level: 3, icon: "わ", title: {en: 'Advanced', he: '转拽'}, screens: [
                { type: 'lesson', title: {en: 'Expanding Your Feelings Vocabulary', he: '专转 爪专  砖 专砖转'}, content: {en: "The more words we have for our feelings, the better we can understand ourselves. Are you 'angry,' or are you 'frustrated,' 'irritated,' or 'impatient'?", he: " 砖砖  转专  专砖转 砖,    转 注爪  转专.  转/ '注住/转',  砖 '转住/转', '注爪/转'  '住专/转 住转'?"} },
                { type: 'exercise', subType: 'matching', question: {en: "Match the situation to a possible feeling.", he: "转 转 住爪 专砖 驻砖专."}, pairs: [{item1: {en: 'Seeing a friend after a long time', he: '专转 专 专 专 '}, item2: {en: 'Joyful', he: '砖'}}, {item1: {en: 'Missing a flight', he: '驻住驻住 住'}, item2: {en: 'Frustration', he: '转住'}}, {item1: {en: 'Receiving a surprise gift', he: '拽 转转 驻转注'}, item2: {en: 'Surprise', he: '驻转注'}}], feedback: {correct: {en: "Great matches! Connecting situations to feelings is a key step.", he: "转转 专转! 专  爪 专砖转  爪注 驻转."}, incorrect: {en: "Let's try that again. Think about what emotion might come up in each situation.", he: " 住 砖. 砖  转砖  注转  爪."}} },
                { type: 'exercise', subType: 'mcq', question: {en: "When you hear 'I feel like you're not listening,' what might be the underlying feeling?", he: "砖转/ 砖注/转 ' 专砖/ 砖转/  拽砖/',  注砖 转 专砖 砖转转?"}, options: [{text: {en: 'Loneliness', he: '转'}, correct: true}, {text: {en: 'Blame', he: '砖'}, correct: false}, {text: {en: 'Logic', he: ''}, correct: false}], feedback: {correct: {en: "Exactly. The feeling of not being heard often points to a deeper feeling of loneliness or a need for connection.", he: "拽. 转砖 砖 拽砖  爪注 注转 拽专转 注 转砖 注拽 转专 砖 转  注 爪专 专."}, incorrect: {en: "Blame and logic are thoughts, not feelings. The core feeling might be loneliness or sadness.", he: "砖   砖转,  专砖转. 专砖 专 注砖 转 转  注爪."}} },
                { type: 'lesson', title: {en: 'Physical Sensations', he: '转砖转 驻转'}, content: {en: "Sometimes the easiest way to identify a feeling is to notice the physical sensation in your body. A tight chest, a warm glow, a knot in your stomach...", he: "驻注 专 拽 转专 转 专砖  砖  转砖 驻转 祝.  抓, 专 , 拽砖专 ..."}, example: {en: "'When I think about the presentation, my stomach feels tight. I am nervous.'", he: "'砖 砖/转 注 爪转,  砖 转爪转.  抓/.'"} },
                { type: 'exercise', subType: 'matching', question: {en: "Match the physical sensation to a likely feeling.", he: "转 转 转砖 驻转 专砖 住专."}, pairs: [{item1: {en: 'Butterflies in stomach', he: '驻专驻专 '}, item2: {en: 'Excitement', he: '转专砖转'}}, {item1: {en: 'Heavy shoulders', he: '转驻 转'}, item2: {en: 'Burdened', he: '注住'}}, {item1: {en: 'Warm chest', he: ' '}, item2: {en: 'Affection', he: ''}}], feedback: {correct: {en: "Great! Your body is a wonderful source of information about your feelings.", he: "专! 祝 砖  拽专 注 驻 注 专砖转 砖."}, incorrect: {en: "Think about what emotion you associate with that physical feeling.", he: "砖 注 专砖 砖转 拽砖专 转砖 驻转 ."}} },
                { type: 'exercise', subType: 'ab-test', question: {en: "Which statement connects a physical sensation to a feeling?", he: " 专 专转 转砖 驻转 专砖?"}, options: [{text: {en: 'My hands are shaking.', he: ' 砖 专注转.'}, correct: false}, {text: {en: 'My hands are shaking, and I am feeling scared.', he: ' 砖 专注转,  砖/ 驻.'}, correct: true}], feedback: {correct: {en: "Yes, this connects the physical data to the emotional data.", he: ",  专 转 转 驻 转 专砖."}, incorrect: {en: "Just stating the sensation is an observation. Connecting it to a feeling word gives it meaning.", he: "专拽 爪 转 转砖  . 专 转 专砖 转  砖注转."}} },
            ], poemImage: "G2.jpg"},
            // Needs
            { id: 7, parent: {en: 'Needs', he: '爪专'}, level: 1, icon: "", title: {en: 'Basics', he: '住转'}, screens: [
                { type: 'lesson', title: {en: 'Connecting to Needs', he: '专 爪专'}, content: {en: "The third step connects our feelings to universal human needs. Our feelings are messengers telling us what we need.", he: "爪注 砖砖 专 转 专砖转 砖 爪专 砖 专住. 专砖转 砖  砖 砖专    爪专."}, example: {en: "'I feel sad *because I have a need for connection*.'", he: "' 注爪/ * 砖  爪专 专*.'"} },
                { type: 'lesson', title: {en: 'What Are Needs?', he: ' 爪专?'}, content: {en: "Needs are universal values like safety, connection, respect, and autonomy. They are common to all people and are never in conflict.", he: "爪专  注专 专住  , 专,  .  砖转驻    注  拽驻拽."}, example: {en: "We all need nourishment, but I might want a salad while you want a pizza.", he: " 爪专 转,    专爪 住 转 转专爪 驻爪."} },
                { type: 'exercise', subType: 'ab-test', question: {en: "Which statement connects a feeling to a need?", he: " 专 专转 专砖 爪专?"}, options: [{text: {en: "I'm angry because you ignored me.", he: " 注住  转注转 ."}, correct: false}, {text: {en: "When you looked away, I felt sad because I need connection.", he: "砖住转 转 , 专砖转 注爪   拽拽/ 专."}, correct: true}], feedback: {correct: {en: "Beautiful! You connected the feeling ('sad') to a universal need ('connection'), rather than blaming the other person.", he: "驻! 专转 转 专砖 ('注爪') 爪专 专住 ('专'), 拽 砖 转  砖."}, incorrect: {en: "The best answer connects the feeling to a universal need, not just the other person's action.", he: "转砖  转专 专转 转 专砖 爪专 专住,  专拽 驻注 砖  砖."}} },
                { type: 'exercise', subType: 'mcq', question: {en: "Which of these is a universal need (not a strategy)?", he: "   爪专 专住 ( 住专)?"}, options: [{text: {en: 'For you to call me', he: '砖转转拽砖专 '}, correct: false}, {text: {en: 'Honesty', he: '转'}, correct: true}, {text: {en: 'A vacation', he: '驻砖'}, correct: false}], feedback: {correct: {en: "That's right! 'Honesty' is a universal value. The others are specific strategies to meet a need.", he: "! '转'  注专 专住. 专  住专转 住驻爪驻转  爪专."}, incorrect: {en: "'Honesty' is a universal need. A phone call or a vacation are strategies to meet needs (like connection or rest).", he: "'转'  爪专 专住. 砖转 驻  驻砖  住专转  爪专 ( 专  )."}} },
                { type: 'exercise', subType: 'ab-test', question: {en: "Which expresses a need, not a strategy?", he: " 专 转 爪专,  住专?"}, options: [{text: {en: "I need you to listen to me.", he: " 爪专 砖转拽砖 ."}, correct: false}, {text: {en: "I need to be heard.", he: " 爪专 砖砖注 转."}, correct: true}], feedback: {correct: {en: "Precisely. 'To be heard' is the core need. 'For you to listen' is one strategy to meet that need.", he: "拽. '转 砖注'  爪专 . '砖转拽砖 '  住专 转  转 爪专 ."}, incorrect: {en: "'To be heard' is the underlying need. Asking someone to listen is a specific strategy.", he: "'转 砖注'  爪专 住住. 拽砖 砖 拽砖  住专 住驻爪驻转."}} },
            ]},
            { id: 8, parent: {en: 'Needs', he: '爪专'}, level: 2, icon: "", title: {en: 'Basics+', he: '住转+'}, screens: [
                { type: 'lesson', title: {en: 'Needs vs. Strategies', he: '爪专  住专转'}, content: {en: "A need is the core value. A strategy is a specific action to meet that need. We often confuse the two.", he: "爪专  注专 . 住专  驻注 住驻爪驻转   转 爪专. 注转 拽专转    砖."}, example: {en: "Strategy: 'I need you to take out the trash.'\nNeed behind it: 'I need support and cooperation.'", he: "住专: ' 爪专 砖转爪 转 .'\n爪专 专 : ' 拽拽/ 转 砖转祝 驻注.'"} },
                { type: 'exercise', subType: 'mcq', question: {en:"'I need a hug.' Is this a need or a strategy?", he: "' 爪专/ 拽.'   爪专  住专?"}, options: [{text: {en:'Need', he: '爪专'}, correct: false}, {text: {en:'Strategy', he: '住专'}, correct: true}], feedback: {correct: {en:"Correct. A hug is a wonderful strategy to meet a need for affection, connection, or comfort.", he: ". 拽  住专 驻  爪专 , 专  ."}, incorrect: {en:"A hug is a specific action (a strategy). The underlying need might be for connection or comfort.", he: "拽  驻注 住驻爪驻转 (住专). 爪专 住住 注砖 转 专  ."}} },
                { type: 'exercise', subType: 'matching', question: {en: "Connect the feeling to a likely unmet need.", he: "专 转 专砖 爪专 住专 砖 转."}, pairs: [{item1: {en: "I'm lonely", he: " "}, item2: {en: "Connection", he: "专"}}, {item1: {en: "I'm scared", he: " 驻"}, item2: {en: "Safety", he: ""}}, {item1: {en: "I'm bored", he: " 砖注"}, item2: {en: "Stimulation", he: "专"}}], feedback: {correct: {en: "Yes! You're getting to the root of what's alive in you.", he: "! 转 注 砖专砖 砖  砖 ."}, incorrect: {en: "Take a moment to see what core value is missing when you have that feeling.", he: "拽 专注 专转  注专  住专 砖砖  转 专砖 ."}} },
                { type: 'exercise', subType: 'ab-test', question: {en:"Which statement focuses on a universal need?", he: " 专 转拽转 爪专 专住?"}, options: [{text: {en:"I need you to be on time.", he: " 爪专 砖转注/ ."}, correct: false}, {text: {en:"I need respect for our agreements.", he: " 拽拽/  住 砖."}, correct: true}], feedback: {correct: {en:"Exactly. 'Respect' is a universal need. Punctuality is one strategy to show respect.", he: "拽. ''  爪专 专住. 拽转  住专 转 专转 ."}, incorrect: {en:"Being on time is a strategy. The underlying need is likely for respect or consideration.", he: "注   住专. 爪专 住住  专   转砖转."}} },
                { type: 'exercise', subType: 'mcq', question: {en:"If a friend cancels plans and you feel disappointed, what need might be unmet?", he: " 专/ /转 转转 转 专砖 ,  爪专 注  转?"}, options: [{text: {en:'Consistency', he: '注拽转'}, correct: true}, {text: {en:'For them to apologize', he: '砖 转爪'}, correct: false}, {text: {en:'Fun', he: '祝'}, correct: false}], feedback: {correct: {en:"Yes, 'consistency' or 'reliability' are common needs in this situation. 'Fun' could also be true!", he: ", '注拽转'  '转'  爪专 驻爪 爪 .  '祝'  转 !"}, incorrect: {en:"An apology is a strategy. The core need might be for consistency, consideration, or connection.", he: "转爪转  住专. 爪专 专 注砖 转 注拽转, 转砖转  专."}} },
            ]},
            { id: 9, parent: {en: 'Needs', he: '爪专'}, level: 3, icon: "", title: {en: 'Advanced', he: '转拽'}, screens: [
                { type: 'lesson', title: {en: "Needs are Never in Conflict", he: "爪专 注  拽驻拽"}, content: {en: "A core idea in NVC is that our universal needs are never in conflict. However, our *strategies* for meeting those needs can be.", he: "专注 专 转拽砖专转 拽专转  砖爪专 专住 砖 注  拽驻拽. 注 转, *住专转* 砖  爪专  转 转."}, example: {en: "My need for quiet and your need for self-expression (by playing music) are both valid. The conflict is in the strategies (silence vs. loud music).", he: "爪专 砖 砖拽 爪专 砖  注爪 (注  转 拽) 砖 转拽驻. 拽驻拽  住专转 (砖拽  拽 专注砖转)."} },
                { type: 'exercise', subType: 'ab-test', question: {en:"Person A wants to open a window for fresh air. Person B wants to keep it closed for warmth. What is the conflict about?", he: " ' 专爪 驻转  专 爪.  ' 专爪 砖专 转 住专  砖 . 注  拽驻拽?"}, options: [{text: {en:'Their needs (fresh air vs. warmth)', he: '爪专 砖 (专 爪  )'}, correct: false}, {text: {en:'Their strategies (window open vs. window closed)', he: '住专转 砖 ( 驻转   住专)'}, correct: true}], feedback: {correct: {en:"Exactly! Both need comfort. The conflict is about the strategy of the window.", he: "拽! 砖 拽拽 转. 拽驻拽   住专 砖 ."}, incorrect: {en:"The needs themselves (comfort, health) aren't in conflict. The chosen strategies are.", he: "爪专 注爪 (转, 专转)  拽驻拽. 住专转 砖专  砖转砖转."}} },
                { type: 'exercise', subType: 'mcq', question: {en:"If you value both honesty and caring for others, which is true?", he: " 转/ 注专/  转  驻转转 驻 专,  ?"}, options: [{text: {en:'These needs will eventually conflict.', he: '爪专  转砖 住驻 砖 专.'}, correct: false}, {text: {en:'You can always find a strategy that honors both needs.', he: '转 驻砖专 爪 住专 砖转 转 砖 爪专.'}, correct: true}], feedback: {correct: {en:"That's the beauty of it. We can be creative and find ways to be both honest and caring.", he: " 驻 砖专.   转 爪专转 爪 专 转    驻转."}, incorrect: {en:"NVC holds that needs themselves never conflict. The challenge is finding creative strategies.", he: "转拽砖专转 拽专转 专住转 砖爪专 注爪 注  转砖. 转专  爪 住专转 爪专转转."}} },
                { type: 'lesson', title: {en: 'Self-Connection', he: '专 注爪'}, content: {en: "Before communicating with others, it's powerful to connect with your own needs first. What is truly important to you in this moment?", he: "驻 转拽砖专转 注 专, 砖  专 爪专 砖 转.  转 砖  专注 ?"} },
                { type: 'exercise', subType: 'mcq', question: {en:"What is the primary purpose of identifying your own needs?", he: " 专 注拽专转 砖  爪专 砖?"}, options: [{text: {en:'To win the argument', he: '爪 '}, correct: false}, {text: {en:'To gain clarity and self-compassion', he: '砖 专转  注爪转'}, correct: true}, {text: {en:'To make the other person meet them', he: '专  专  转'}, correct: false}], feedback: {correct: {en:"Yes. Understanding our own needs brings clarity and allows us to care for ourselves.", he: ". 转 爪专 砖  专转 驻砖专转   注爪."}, incorrect: {en:"The first step is always internal clarity and self-compassion. The request comes later.", he: "爪注 专砖  转 专转 驻转  注爪转. 拽砖 注 专 转专."}} },
            ], poemImage: "G3.jpg"},
            // Requests
            { id: 10, parent: {en: 'Requests', he: '拽砖转'}, level: 1, icon: "ｏ", title: {en: 'Basics', he: '住转'}, screens: [
                { type: 'lesson', title: {en: "Making Requests", he: "住 拽砖转"}, content: {en: "The final step is to make a clear, positive, and doable request for an action to help meet our need. This is a request, not a demand.", he: "砖 专  住 拽砖 专专, 转 专转-爪注 驻注 砖转注专  转 爪专 砖.  拽砖,  专砖."}, example: {en: "Demand: 'Stop being so loud!'\nRequest: 'Would you be willing to lower your voice?'", he: "专砖: '转驻住拽 转   专注砖!'\n拽砖: '转   转 拽?'"} },
                { type: 'exercise', subType: 'mcq', question: {en: "Which is a clear and doable request?", he: " 拽砖  专专 专转-爪注?"}, options: [{text: {en: 'Be more respectful.', he: '转 转专 .'}, correct: false}, {text: {en: 'Show me you care.', he: '转专  砖驻转 .'}, correct: false}, {text: {en: 'Would you tell me what you heard me say?', he: ' 转专/   砖注转 转 专/转?'}, correct: true}], feedback: {correct: {en: "Perfect! That is a specific, concrete action someone can take in the present moment.", he: "砖!  驻注 住驻爪驻转 砖转 砖砖  爪注 专注 ."}, incorrect: {en: "The best requests are for specific actions. 'Be more respectful' is too vague. What action equals respect?", he: "拽砖转 转 转专  驻注转 住驻爪驻转. '转 转专 ' 注专驻 .  驻注 砖 ?"}} },
                { type: 'exercise', subType: 'ab-test', question: {en: "Which is more likely to be heard as a request, not a demand?", he: " 专 爪驻 砖注 拽砖,  专砖?"}, options: [{text: {en: 'You need to take out the trash now.', he: '转 爪专 爪 转  注砖.'}, correct: false}, {text: {en: 'Would you be willing to take out the trash?', he: ' 转/ / 爪 转 ?'}, correct: true}], feedback: {correct: {en: "Exactly. Phrasing it as a 'Would you be willing...?' question opens the door for connection, even if the answer is no.", he: "拽. 住 砖 ' 转/ /...?' 驻转 转 专,   转砖  ."}, incorrect: {en: "Using phrases like 'Would you be willing...?' invites cooperation, whereas 'You need to...' can sound like a demand.", he: "砖砖   ' 转/ /...?'  砖转祝 驻注, 注 砖'转 爪专...'  砖注 专砖."}} },
                { type: 'exercise', subType: 'ab-test', question: {en: "Which is a positive action request?", he: " 拽砖 驻注 转?"}, options: [{text: {en: 'Could you please speak more quietly?', he: '转/ 拽砖 专 砖拽 转专?'}, correct: true}, {text: {en: 'Can you stop shouting?', he: '驻砖专 驻住拽 爪注拽?'}, correct: false}], feedback: {correct: {en: "Yes, you're asking for the action you want ('speak quietly') instead of the one you don't ('shouting').", he: ", 转 拽砖 转 驻注 砖转 专爪 ('专 砖拽') 拽 转  砖转  专爪 ('爪注拽')."}, incorrect: {en: "Asking someone to 'stop' an action is less effective than asking for the action you desire instead.", he: "拽砖 砖 '驻住拽' 驻注 驻转 注 拽砖 转 驻注 专爪 拽 转."}} },
                { type: 'exercise', subType: 'mcq', question: {en: "What is the 'F' in the OFNR sequence?", he: " '专' 专爪祝 , 专砖, 爪专, 拽砖?"}, options: [{text: {en: 'Fact', he: '注 (Fact)'}, correct: false}, {text: {en: 'Feeling', he: '专砖 (Feeling)'}, correct: true}, {text: {en: 'Fix', he: '转拽 (Fix)'}, correct: false}], feedback: {correct: {en: "You got it! O-F-N-R stands for Observation, Feeling, Need, Request.", he: "转驻住转 转 ! 专爪祝  , 专砖, 爪专, 拽砖."}, incorrect: {en: "The F is for Feeling. Remember: Observation, Feeling, Need, Request.", he: "-专'  注专 专砖. 专: , 专砖, 爪专, 拽砖."}} },
            ]},
            { id: 11, parent: {en: 'Requests', he: '拽砖转'}, level: 2, icon: "ｏ", title: {en: 'Basics+', he: '住转+'}, screens: [
                { type: 'lesson', title: {en: 'Request vs. Demand', he: '拽砖  专砖'}, content: {en: "A key difference is our willingness to hear 'no'. If we are not open to hearing 'no', our request is actually a demand.", he: " 专  转 砖 砖注 ''.   驻转 砖注 '', 拽砖 砖  注砖 专砖."} },
                { type: 'exercise', subType: 'ab-test', question: {en:"'I would like you to come with me.' Is this a request or a demand?", he: "'转 专爪 砖转/ 转.'   拽砖  专砖?"}, options: [{text: {en:"It's a request if I'm okay with 'no'.", he: " 拽砖   住专 注 ''."}, correct: true}, {text: {en:"It's always a demand.", he: " 转 专砖."}, correct: false}], feedback: {correct: {en:"Exactly. The energy behind the words matters more than the words themselves.", he: "拽. 专 砖专  砖 转专  注爪."}, incorrect: {en:"The key is our internal state. Are we truly open to any answer?", he: "驻转  爪 驻 砖.   转 驻转  转砖?"}} },
                { type: 'lesson', title: {en: 'Positive Action Language', he: '砖驻转 驻注 转'}, content: {en: "It's more effective to ask for what we *do* want, rather than what we *don't* want. Our brains find it easier to do something than to not do something.", he: "转专 注 拽砖 转  砖 ** 专爪, 拽 转  砖 ** 专爪.  砖 拽 转专 注砖转 砖 砖专  注砖转 砖."}, example: {en: "Instead of: 'Please don't be late.'\nTry: 'Could you please arrive by 8pm?'", he: "拽: '拽砖  转专/.'\n住: '转/ 拽砖 注 注 20:00?'"} },
                { type: 'exercise', subType: 'ab-test', question: {en:"Which is a positive action request?", he: " 拽砖 驻注 转?"}, options: [{text: {en:"Don't leave your clothes on the floor.", he: " 转砖专/ 转  砖 注 专爪驻."}, correct: false}, {text: {en:"Would you be willing to put your clothes in the hamper?", he: " 转/ / 砖 转  砖 住 住?"}, correct: true}], feedback: {correct: {en:"Yes. This gives a clear, positive action to take.", he: ".  转 驻注 专专 转 爪注."}, incorrect: {en:"Telling someone what *not* to do can be confusing. It's clearer to ask for what you *do* want.", he: "专 砖  ** 注砖转  转 . 专专 转专 拽砖 转  砖** 专爪."}} },
                { type: 'exercise', subType: 'mcq', question: {en:"Your request should be for something that can be done...", he: "拽砖 砖 爪专 转 砖 砖转 注砖转..."}, options: [{text: {en:'Sometime in the future', he: '转砖 注转'}, correct: false}, {text: {en:'In the present moment', he: '专注 '}, correct: true}, {text: {en:'Whenever they feel like it', he: '转 砖转砖拽 '}, correct: false}], feedback: {correct: {en:"Yes! Actionable, present-moment requests are the most effective.", he: "! 拽砖转 专转-爪注 专注   注转 转专."}, incorrect: {en:"Vague, future-based requests are hard to act on. Be specific and present-focused.", he: "拽砖 驻注 注 驻 拽砖转 注专驻转 住住转-注转.  住驻爪驻 拽-."}} },
                { type: 'exercise', subType: 'matching', question: {en:"Match the vague request to a more specific one.", he: "转 转 拽砖 注专驻转 拽砖 住驻爪驻转 转专."}, pairs: [{item1: {en: 'Help me more.', he: '转注专/  转专.'}, item2: {en: 'Can you wash the dishes tonight?', he: '转/ 砖祝  注专?'}}, {item1: {en: 'Be more loving.', he: '转/ 转专 /转.'}, item2: {en: 'Would you give me a hug?', he: '驻砖专 拽?'}}, {item1: {en: 'Listen to me.', he: '转拽砖/ .'}, item2: {en: 'Can you tell me what you heard?', he: '转/ 专   砖注转?'}}], feedback: {correct: {en:"Great! Specificity is key to making requests that can actually be met.", he: "专! 住驻爪驻转  驻转 拽砖转 砖转  驻注."}, incorrect: {en:"Look for the request that names a concrete, doable action.", he: "驻砖 转 拽砖 砖爪转 驻注 拽拽专转 专转-爪注."}} },
            ]},
            { id: 12, parent: {en: 'Requests', he: '拽砖转'}, level: 3, icon: "ｏ", title: {en: 'Advanced', he: '转拽'}, screens: [
                { type: 'lesson', title: {en: 'Connection vs. Action Requests', he: '拽砖转 专  拽砖转 驻注'}, content: {en: "Sometimes, the request isn't for an action, but for connection. For example, asking someone to reflect back what they heard.", he: "驻注, 拽砖  驻注,  专. , 拽砖 砖 砖拽祝 专 转  砖砖注."}, example: {en: "Action Request: 'Would you be willing to take out the trash?'\nConnection Request: 'I'd love to hear how that lands for you.'", he: "拽砖转 驻注: ' 转/ / 爪 转 ?'\n拽砖转 专: '砖 砖注   转 爪.'"} },
                { type: 'exercise', subType: 'mcq', question: {en:"'Could you tell me if you'd be open to talking about this later?' This is primarily a request for:", he: "'转/ 专   转/ 驻转/ 专 注  专 转专?'  注拽专 拽砖 :"}, options: [{text: {en:'Action', he: '驻注'}, correct: false}, {text: {en:'Connection and clarity', he: '专 专转'}, correct: true}], feedback: {correct: {en:"Yes, it's checking for willingness and opening a dialogue, which are about connection.", he: ",  拽 转 驻转 , 砖 注 砖 专."}, incorrect: {en:"While it involves talking (an action), the main purpose is to check in and connect about future possibilities.", he: "  专 专 (驻注),  专 注拽专转  拽 转专  驻砖专转 注转转."}} },
                { type: 'lesson', title: {en: 'The Full Path (OFNR)', he: '砖  (, 专砖, 爪专, 拽砖)'}, content: {en: "Let's put it all together! Observation, Feeling, Need, Request.", he: " 专  ! , 专砖, 爪专, 拽砖."}, example: {en: "'When I see the wet towel on the bed (O), I feel irritated (F), because I have a need for order in our shared space (N). Would you be willing to hang it in the bathroom (R)?'", he: "砖 专 转 转 专 注  (),  专砖/ 注爪转 (专砖),  砖  爪专 住专 专 砖转祝 砖 (爪专).  拽砖/转  转/ 转转 转 专  (拽砖).'"} },
                { type: 'exercise', subType: 'mcq', question: {en:"In 'When you arrive late, I feel worried because I need reassurance that you are safe. Would you text me if you're running late?', what is the NEED?", he: "砖驻 '砖转 专,  转   爪专 砖专 砖转 .  转住住   转 专?',  爪专?"}, options: [{text: {en:'To not be late', he: ' 专'}, correct: false}, {text: {en:'Reassurance/Safety', he: '砖专/'}, correct: true}, {text: {en:'To get a text message', he: '拽 注转 拽住'}, correct: false}], feedback: {correct: {en:"Exactly! The need is for reassurance and safety.", he: "拽! 爪专  砖专 ."}, incorrect: {en:"Getting a text is the strategy. Not being late is also a strategy. The core need is for reassurance/safety.", he: "拽转 注转 拽住  住专.  专   住专. 爪专   砖专/."}} },
                { type: 'exercise', subType: 'ab-test', question: {en:"Which is a full OFNR expression?", he: " 专   OFNR ?"}, options: [{text: {en:"It's annoying when you're on your phone.", he: " 注爪 砖转 驻."}, correct: false}, {text: {en:"When I see you on your phone while we're talking, I feel lonely because I need connection. Would you put your phone away?", he: "砖 专 转 驻  砖 专,  专砖    爪专 专. 转/  转 驻 爪?"}, correct: true}], feedback: {correct: {en:"Perfect. That contains a clear Observation, Feeling, Need, and Request.", he: "砖.   , 专砖, 爪专 拽砖 专专."}, incorrect: {en:"The first option is an evaluation and doesn't contain all four components.", he: "驻砖专转 专砖  注专   转  专注转 专."}} },
                { type: 'exercise', subType: 'mcq', question: {en:"What is the 'R' in the OFNR sequence?", he: " '' 专爪祝 , 专砖, 爪专, 拽砖?"}, options: [{text: {en:'Reason', he: '住 (Reason)'}, correct: false}, {text: {en:'Reaction', he: '转 (Reaction)'}, correct: false}, {text: {en:'Request', he: '拽砖 (Request)'}, correct: true}], feedback: {correct: {en:"You got it! O-F-N-R stands for Observation, Feeling, Need, Request.", he: "转驻住转 转 ! 专爪祝  , 专砖, 爪专, 拽砖."}, incorrect: {en:"The R is for Request. Remember: Observation, Feeling, Need, Request.", he: "-'  注专 拽砖. 专: , 专砖, 爪专, 拽砖."}} },
            ], poemImage: "G4.jpg"},
            // Empathy Section
            { id: 13, parent: {en: 'Empathy', he: '驻转'}, level: 1, icon: "", title: {en: "Empathy 1", he: "驻转 1"}, screens: [], comingSoon: true },
            { id: 14, parent: {en: 'Empathy', he: '驻转'}, level: 2, icon: "", title: {en: "Empathy 2", he: "驻转 2"}, screens: [], comingSoon: true },
            { id: 15, parent: {en: 'Empathy', he: '驻转'}, level: 3, icon: "", title: {en: "Empathy 3", he: "驻转 3"}, screens: [], comingSoon: true },
        ];

        function saveData() { localStorage.setItem('nvcCourseProgress', JSON.stringify(state)); }
        function loadData() {
            const savedData = localStorage.getItem('nvcCourseProgress');
            if (savedData) {
                const parsed = JSON.parse(savedData);
                state = { ...defaultState, ...parsed };
            } else {
                state = { ...defaultState };
            }
        }
        function createButton(text, onClick, extraClass = '') { const btn = document.createElement('button'); btn.innerHTML = text; btn.className = `btn ${extraClass}`; btn.onclick = onClick; return btn; }
        
        function getTranslation(obj) {
            if (typeof obj !== 'object' || obj === null) {
                return obj;
            }
            return obj[state.lang] || obj['en'];
        }

        function updateUI() { 
            const t = getTranslation(courseContent);
            const totalPlayableModules = modules.filter(m => !m.comingSoon).length;
            let progressPercentage = totalPlayableModules > 0 ? (state.completedModules.length / totalPlayableModules) * 100 : 0;
            
            livesDisplay.style.display = 'none';
            
            if (state.view === 'stage') {
                const module = modules.find(s => s.id === state.activeModule.id);
                if (module) {
                    const exercisesInModule = module.screens.filter(s => s.type === 'exercise').length;
                    const completedExercises = state.activeModule.completedExercises ? state.activeModule.completedExercises.length : 0;
                    progressPercentage = exercisesInModule > 0 ? (completedExercises / exercisesInModule) * 100 : 0;
                    
                    livesDisplay.innerHTML = `わ`.repeat(state.activeModule.lives);
                    livesDisplay.style.display = 'block';
                }
            }
            
            progressBar.style.width = `${progressPercentage}%`;
            xpDisplay.innerHTML = ` ${state.xp}`; 
            soundToggle.textContent = state.isMuted ? '' : '';
            themeToggle.textContent = document.body.classList.contains('dark-mode') ? '锔' : '';
            document.body.dir = state.lang === 'he' ? 'rtl' : 'ltr';
            
            const giraffeIndex = Math.min(state.completedModules.length, giraffeSVGs.length - 1);
            giraffeSvgContainer.innerHTML = giraffeSVGs[giraffeIndex];
            renderMiniMap();
        }

        function render() {
            updateUI();
            contentArea.innerHTML = '';
            const view = state.view;
            if (view === 'map') renderMapView();
            else if (view === 'stage') renderModuleView();
            else if (view === 'moduleComplete') renderModuleCompleteScreen();
            else if (view === 'moduleFailed') renderModuleFailedScreen();
            else if (view === 'final') renderFinalScreen();
            else if (view === 'poem') renderPoemScreen();
        }
        
        function renderPoemScreen() {
            const t = getTranslation(courseContent);
            const module = modules.find(m => m.id === state.activeModule.id);
            contentArea.innerHTML = `
                <div class="poem-container">
                    <img src="${module.poemImage}" alt="NVC Poem" class="poem-image" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Image+not+found';">
                    <button id="poem-continue-btn" class="btn btn-primary">${t.continueToMap}</button>
                </div>
            `;
            document.getElementById('poem-continue-btn').onclick = () => {
                state.view = 'map';
                render();
            };
        }

        function renderMiniMap() {
            const container = document.getElementById('mini-map-container');
            if (!container) return;
            container.innerHTML = '';
            const uniqueParentNames = [...new Set(modules.map(m => m.parent.en))];
            const allParents = uniqueParentNames.map(name => modules.find(m => m.parent.en === name).parent);

            allParents.forEach(parent => {
                const group = document.createElement('div');
                group.className = 'mini-map-group';
                const parentModules = modules.filter(m => m.parent.en === parent.en);
                parentModules.forEach(module => {
                    const dot = document.createElement('div');
                    dot.className = 'mini-map-dot';
                    dot.title = getTranslation(module.title);
                    if(module.comingSoon) {
                        dot.classList.add('coming-soon');
                    } else if (state.completedModules.includes(module.id)) {
                        dot.classList.add('completed');
                    } else if (state.completedModules.length + 1 === module.id) {
                        dot.classList.add('unlocked');
                    } else {
                        dot.classList.add('locked');
                    }
                    group.appendChild(dot);
                });
                container.appendChild(group);
            });
        }

        function renderMapView() {
            const t = getTranslation(courseContent);

            const uniqueParentNames = [...new Set(modules.map(m => m.parent.en))];
            const allParents = uniqueParentNames.map(name => modules.find(m => m.parent.en === name).parent);

            let currentParent = allParents[0];
            const nextModuleId = state.completedModules.length + 1;
            const nextModule = modules.find(m => m.id === nextModuleId);
            if (nextModule) {
                currentParent = nextModule.parent;
            } else {
                const lastCompletedModule = modules.find(m => m.id === state.completedModules.length);
                if(lastCompletedModule) {
                    currentParent = lastCompletedModule.parent;
                }
            }
            
            const renderSection = (title, sectionModules) => {
                const mapView = document.createElement('div');
                mapView.className = 'map-view';
                mapView.innerHTML = `<h2 class="level-title">${title}</h2>`;
                sectionModules.forEach(moduleData => {
                    const node = document.createElement('div');
                    node.className = 'stage-node';
                    const isCompleted = state.completedModules.includes(moduleData.id);
                    const isUnlocked = !moduleData.comingSoon && state.completedModules.length + 1 === moduleData.id;
                    const isLocked = !isCompleted && !isUnlocked;
                    
                    const button = document.createElement('button');
                    button.className = 'stage-button';
                    
                    if (moduleData.comingSoon) {
                        button.classList.add('coming-soon');
                    } else if(isCompleted) {
                        button.classList.add('completed');
                    } else if(isUnlocked) {
                        button.classList.add('unlocked');
                    } else {
                        button.classList.add('locked');
                    }
                    
                    button.disabled = isLocked || moduleData.comingSoon;
                    let levelIndicator = '';
                    if (moduleData.level === 2) {
                        levelIndicator = '';
                    } else if (moduleData.level === 3) {
                        levelIndicator = '';
                    }
                    button.innerHTML = `<div class="stage-icon-container"><div class="stage-icon">${moduleData.icon}</div><div class="level-indicator">${levelIndicator}</div></div><div class="stage-title-map">${getTranslation(moduleData.title)}</div>`;
                    
                    if (!moduleData.comingSoon) {
                        button.onclick = () => { 
                            gtag('event', 'module_start', { 'module_id': moduleData.id });
                            state.view = 'stage'; 
                            state.activeModule = { id: moduleData.id, screen: 0, lives: 3, completedExercises: [] }; 
                            render(); 
                        };
                    }

                    if (isUnlocked) {
                        const botIcon = document.createElement('div');
                        botIcon.className = 'giraffe-map-icon';
                        const giraffeIndex = Math.min(state.completedModules.length, giraffeSVGs.length - 1);
                        botIcon.innerHTML = giraffeSVGs[giraffeIndex];
                        node.appendChild(botIcon);
                    }
                    node.appendChild(button);
                    mapView.appendChild(node);
                });
                contentArea.appendChild(mapView);
            };
            
            const playableModules = modules.filter(m => !m.comingSoon);
            if (state.completedModules.length === playableModules.length) {
                state.view = 'final';
                render();
                return;
            }

            renderSection(getTranslation(currentParent), modules.filter(m => m.parent.en === currentParent.en));
            
            const mainModules = modules.filter(m => m.parent.en !== 'Empathy');
            if (state.completedModules.length >= mainModules.length) {
                 renderSection(t.empathyTitle, modules.filter(m => m.parent.en === 'Empathy'));
            }

            giraffeSpeech.textContent = t.mapSpeech;
        }

        function renderModuleView() {
            const t = getTranslation(courseContent);
            const module = modules.find(s => s.id === state.activeModule.id);
            if (!module) return;
            const screenData = module.screens[state.activeModule.screen];

            const header = document.createElement('div');
            header.className = 'screen-header';
            
            const backButton = document.createElement('button');
            backButton.className = 'back-to-menu-btn';
            backButton.innerHTML = '&#x2190;'; // Left arrow
            if (state.lang === 'he') {
                backButton.innerHTML = '&#x2192;'; // Right arrow for RTL
            }
            backButton.title = t.backToMenu;
            backButton.onclick = () => {
                state.view = 'map';
                render();
            };
            
            const title = document.createElement('h1');
            title.className = 'screen-title';
            
            const placeholder = document.createElement('div');
            placeholder.style.width = '2rem'; // Same as back button approx
            
            header.appendChild(backButton);
            header.appendChild(title);
            header.appendChild(placeholder);
            
            contentArea.appendChild(header);
            
            giraffeSpeech.textContent = t.stageSpeech;

            if (screenData.type === 'lesson') {
                title.textContent = getTranslation(screenData.title);
                const content = document.createElement('p'); 
                content.className = 'lesson-content'; 
                content.innerHTML = getTranslation(screenData.content); 
                contentArea.appendChild(content);
                
                if (screenData.example) { 
                    const example = document.createElement('div'); 
                    example.className = 'lesson-example'; 
                    example.innerHTML = getTranslation(screenData.example).replace(/\n/g, '<br>'); 
                    contentArea.appendChild(example); 
                }
                
                const nextButton = createButton(t.continue, () => advanceScreen(), 'btn-primary');
                contentArea.appendChild(nextButton);
            } else if (screenData.type === 'exercise') {
                title.textContent = `${getTranslation(module.parent)} - ${getTranslation(module.title)}`;
                renderExerciseScreen(screenData);
            }
        }
        
        function advanceScreen() {
            const module = modules.find(s => s.id === state.activeModule.id);
            if (state.activeModule.screen < module.screens.length - 1) {
                state.activeModule.screen++; render();
            } else {
                state.view = 'moduleComplete';
                render();
            }
        }
        
        function completeModule() {
            const currentModule = modules.find(m => m.id === state.activeModule.id);
            if (!state.completedModules.includes(state.activeModule.id)) {
                gtag('event', 'module_complete', { 'module_id': state.activeModule.id });
                state.completedModules.push(state.activeModule.id);
                state.xp += 25;
            }

            // Check if this is the last module of a parent category and has a poem
            const parentModules = modules.filter(m => m.parent.en === currentModule.parent.en);
            const lastModuleOfParent = parentModules[parentModules.length - 1];
            if (currentModule.id === lastModuleOfParent.id && currentModule.poemImage) {
                state.view = 'poem';
                saveData();
                render();
                return;
            }

            const playableModules = modules.filter(m => !m.comingSoon);
            if (state.completedModules.length >= playableModules.length) {
                gtag('event', 'level_complete', { 'level_id': 1 });
                state.view = 'final';
            } else {
                state.view = 'map';
            }
            saveData();
            render();
        }

        function handleAnswer(button, isCorrect, feedbackData) {
            const t = getTranslation(courseContent);
            contentArea.querySelectorAll('button:not(.btn-primary)').forEach(b => b.disabled = true);
            const feedbackSection = document.createElement('div');
            const nextButtonContainer = document.createElement('div');
            feedbackSection.id = 'feedback-section';
            feedbackSection.innerHTML = `<div class="feedback-message"></div>`;
            nextButtonContainer.id = 'next-button-container';
            feedbackSection.appendChild(nextButtonContainer);
            const feedbackMessage = feedbackSection.querySelector('.feedback-message');
            
            const feedback = {
                correct: getTranslation(feedbackData.correct),
                incorrect: getTranslation(feedbackData.incorrect)
            };

            if (isCorrect) {
                playSound('correct');
                state.xp += 10;
                state.streak++;
                // Only add to completed exercises if it's not already there
                if (!state.activeModule.completedExercises.includes(state.activeModule.screen)) {
                    state.activeModule.completedExercises.push(state.activeModule.screen);
                }

                button.classList.add('correct');
                feedbackMessage.textContent = feedback.correct;
                feedbackMessage.className = 'feedback-message correct';
                if (state.streak >= 3) { giraffeSpeech.textContent = getTranslation({en: "You're connecting so well! ", he: "转 转专   ! "}); playSound('streak'); }
                else { giraffeSpeech.textContent = t.gotIt; }
                const nextButton = createButton(t.continue, () => advanceScreen(), 'btn-primary');
                nextButtonContainer.appendChild(nextButton);
            } else {
                gtag('event', 'answer_incorrect', { 'module_id': state.activeModule.id, 'screen_id': state.activeModule.screen });
                playSound('incorrect');
                state.streak = 0;
                state.activeModule.lives--;
                button.classList.add('incorrect');
                feedbackMessage.textContent = feedback.incorrect;
                feedbackMessage.className = 'feedback-message incorrect';
                giraffeSpeech.textContent = getTranslation({en: "That's a common mix-up. Let's look again.", he: "  驻抓.  住 砖."});

                if (state.activeModule.lives <= 0) {
                    state.view = 'moduleFailed';
                    setTimeout(render, 1500);
                } else {
                    const retryButton = createButton(t.tryAgain, () => render());
                    nextButtonContainer.appendChild(retryButton);
                }
            }
            contentArea.appendChild(feedbackSection);
            saveData();
            updateUI();
        }
        
        function renderFinalScreen() {
            const t = getTranslation(courseContent);
            contentArea.innerHTML = '';
            const title = document.createElement('h1');
            title.className = 'completion-title';
            title.textContent = t.finalTitle;
            contentArea.appendChild(title);
            const content = document.createElement('p');
            content.className = 'lesson-content';
            content.innerHTML = `${t.finalContent}<br><br><strong>${t.comingSoon}</strong>`;
            contentArea.appendChild(content);

            const completionActions = document.createElement('div');
            completionActions.className = 'completion-actions';
            
            const feedbackButton = createButton(t.feedbackCTA, () => window.open('https://forms.gle/V5ZWLzknQLtLNEUg8', '_blank'), 'btn-primary');
            completionActions.appendChild(feedbackButton);

            const supportText = document.createElement('p');
            supportText.textContent = t.supportCTA;
            supportText.style.fontSize = '0.9rem';
            supportText.style.marginTop = '1rem';
            completionActions.appendChild(supportText);
            
            const supportButton = createButton(t.supportProject, () => window.open('https://revolut.me/yonatahf89', '_blank'));
            completionActions.appendChild(supportButton);

            const resetButton = document.createElement('button');
            resetButton.id = 'reset-progress-btn';
            resetButton.textContent = t.resetProgress;
            resetButton.onclick = showResetConfirmModal;
            completionActions.appendChild(resetButton);

            contentArea.appendChild(completionActions);
            
            for(let i=0; i<100; i++) { const c = document.createElement('div'); c.className='confetti'; c.style.left=Math.random()*100+'vw'; c.style.animationDuration=Math.random()*2+3+'s'; c.style.backgroundColor=`hsl(${Math.random()*360},100%,50%)`; document.body.appendChild(c); setTimeout(() => { c.remove() }, 5000); }
            giraffeSpeech.textContent = t.finalBot;
        }

        function renderModuleCompleteScreen() {
            playSound('moduleComplete');
            const t = getTranslation(courseContent);
            contentArea.innerHTML = '';
            const icon = document.createElement('div');
            icon.className = 'completion-icon';
            icon.textContent = '';
            contentArea.appendChild(icon);
            const title = document.createElement('h2');
            title.className = 'completion-title';
            title.textContent = t.moduleComplete;
            contentArea.appendChild(title);

            const completionActions = document.createElement('div');
            completionActions.className = 'completion-actions';
            
            const continueButton = createButton(t.continueToMap, () => completeModule(), 'btn-primary');
            completionActions.appendChild(continueButton);
            
            const playableModules = modules.filter(m => !m.comingSoon);
            if (state.activeModule.id === playableModules.length) {
                 const feedbackButton = createButton(t.feedbackCTA, () => window.open('https://forms.gle/V5ZWLzknQLtLNEUg8', '_blank'));
                 completionActions.appendChild(feedbackButton);
            }

            const resetButton = document.createElement('button');
            resetButton.id = 'reset-progress-btn';
            resetButton.textContent = t.resetProgress;
            resetButton.onclick = showResetConfirmModal;
            completionActions.appendChild(resetButton);

            contentArea.appendChild(completionActions);
        }

        function renderModuleFailedScreen() {
            const t = getTranslation(courseContent);
            contentArea.innerHTML = '';
            const icon = document.createElement('div');
            icon.className = 'completion-icon';
            icon.textContent = '';
            contentArea.appendChild(icon);
            const title = document.createElement('h2');
            title.className = 'completion-title';
            title.textContent = t.outOfTries;
            contentArea.appendChild(title);
            const content = document.createElement('p');
            content.className = 'lesson-content';
            content.textContent = t.outOfTriesMsg;
            contentArea.appendChild(content);
            const retryButton = createButton(t.tryAgain, () => {
                state.view = 'map'; render();
            }, 'btn-primary');
            contentArea.appendChild(retryButton);
        }

        function renderExerciseScreen(screenData) {
            const questionText = getTranslation(screenData.question);
            const question = document.createElement('p'); question.className = 'exercise-question'; question.textContent = questionText; contentArea.appendChild(question);
            const choiceContainer = document.createElement('div');
            switch(screenData.subType) {
                case 'mcq': case 'ab-test':
                    choiceContainer.className = 'choice-grid';
                    screenData.options.forEach(option => { 
                        const btn = createButton(getTranslation(option.text), () => handleAnswer(btn, option.correct, screenData.feedback));
                        choiceContainer.appendChild(btn);
                     });
                    break;
                case 'matching':
                     choiceContainer.className = 'matching-grid';
                     renderMatchingExercise(screenData, choiceContainer);
                     break;
            }
            contentArea.appendChild(choiceContainer);
        }

        function renderMatchingExercise(data, container) {
            const translatedPairs = data.pairs.map(p => ({
                item1: getTranslation(p.item1),
                item2: getTranslation(p.item2)
            }));
            const allItems = translatedPairs.flatMap(p => [p.item1, p.item2]);
            const shuffledItems = [...allItems].sort(() => Math.random() - 0.5);

            let selectedButton = null;
            let correctPairs = 0;

            const checkMatch = (clickedButton) => {
                if (!selectedButton) {
                    selectedButton = clickedButton;
                    selectedButton.classList.add('selected');
                    return;
                }
                if (selectedButton === clickedButton) { 
                    selectedButton.classList.remove('selected'); 
                    selectedButton = null; 
                    return; 
                }
                
                const val1 = selectedButton.textContent;
                const val2 = clickedButton.textContent;
                const isMatch = translatedPairs.some(p => (p.item1 === val1 && p.item2 === val2) || (p.item1 === val2 && p.item2 === val1));
                
                const btn1 = selectedButton;
                const btn2 = clickedButton;

                if (isMatch) {
                    playSound('correct');
                    [btn1, btn2].forEach(btn => {
                        if (btn) {
                            btn.classList.remove('selected'); 
                            btn.classList.add('correct'); 
                            btn.disabled = true; 
                        }
                    });
                    correctPairs++;
                    if (correctPairs === translatedPairs.length) { 
                        setTimeout(() => handleAnswer(container, true, data.feedback), 300); 
                    }
                } else {
                    playSound('incorrect');
                    [btn1, btn2].forEach(btn => {
                        if(btn) btn.classList.add('incorrect');
                    });
                    setTimeout(() => { 
                        [btn1, btn2].forEach(btn => {
                            if(btn) btn.classList.remove('incorrect', 'selected');
                        }); 
                    }, 800);
                }
                selectedButton = null;
            };

            shuffledItems.forEach(text => {
                const btn = createButton(text, () => checkMatch(btn), 'matching-pair');
                container.appendChild(btn);
            });
        }
        
        function setTheme(theme) {
            state.theme = theme;
            document.body.classList.toggle('dark-mode', theme === 'dark');
            saveData();
            updateUI();
        }
        
        function setLanguage(lang) {
            state.lang = lang;
            const t = getTranslation(courseContent);
            
            welcomeTitle.textContent = t.welcomeTitle;
            welcomeText.textContent = t.welcomeText;
            langSelectLabel.textContent = t.langSelectLabel;
            startCourseBtn.innerHTML = t.letsGo;
            supportLink.textContent = t.supportProject;
            termsLink.textContent = t.terms;
            privacyLink.textContent = t.privacy;
            cookieText.textContent = t.cookieText;
            acceptCookiesBtn.textContent = t.accept;
            declineCookiesBtn.textContent = t.decline;
            closePolicyBtn.textContent = t.close;
            resetConfirmTitle.textContent = t.resetConfirmTitle;
            resetConfirmText.textContent = t.resetConfirmText;
            confirmResetBtn.textContent = t.confirmReset;
            cancelResetBtn.textContent = t.cancel;


            langBtnEn.classList.toggle('active', lang === 'en');
            langBtnHe.classList.toggle('active', lang === 'he');

            document.body.dir = state.lang === 'he' ? 'rtl' : 'ltr';
            saveData();
        }

        function showPolicy(type) {
            const t = getTranslation(courseContent);
            const contactEmail = '10mvpsin20days@gmail.com';
            policyTitle.textContent = t[type];
            let policyContent = `<p>Last updated: July 8, 2024</p><p>For any questions, please contact us at <a href="mailto:${contactEmail}">${contactEmail}</a>.</p>`;
            if (type === 'privacy') {
                policyContent += `<p>We use Google Analytics to collect anonymous data about website usage to improve our service. This data is not personally identifiable. You can accept or decline this via the cookie consent banner. We do not sell or share your data with third parties.</p>`;
            } else {
                policyContent += `<p>By using this service, you agree to use it for educational purposes only. You agree not to reproduce or distribute the content without permission.</p>`;
            }
            policyText.innerHTML = policyContent;
            policyModalOverlay.style.display = 'flex';
        }

        function showResetConfirmModal() {
            resetConfirmModalOverlay.style.display = 'flex';
        }

        function resetProgress() {
            localStorage.removeItem('nvcCourseProgress');
            localStorage.removeItem('nvcCourseWelcomedV2');
            localStorage.removeItem('cookieConsent');
            location.reload();
        }

        function init() {
            loadData();
            setTheme(state.theme); 
            setLanguage(state.lang);
            
            supportLink.href = "https://revolut.me/yonatahf89";
            
            const cookieConsent = localStorage.getItem('cookieConsent');
            if (cookieConsent === 'true') {
                gtag('config', 'G-M27LTF4SQG');
            } else if (!cookieConsent) {
                cookieBanner.style.display = 'flex';
            }
            
            // Default to Hebrew, skip welcome modal for faster start
            if (false && !localStorage.getItem('nvcCourseWelcomedV2')) {
                welcomeModalOverlay.style.display = 'flex';
            } else {
                render();
            }
            
            langBtnEn.addEventListener('click', () => setLanguage('en'));
            langBtnHe.addEventListener('click', () => setLanguage('he'));
            startCourseBtn.addEventListener('click', () => {
                welcomeModalOverlay.style.display = 'none';
                localStorage.setItem('nvcCourseWelcomedV2', 'true');
                saveData();
                render();
            });

            // Footer and Modal Listeners
            termsLink.addEventListener('click', (e) => { e.preventDefault(); showPolicy('terms'); });
            privacyLink.addEventListener('click', (e) => { e.preventDefault(); showPolicy('privacy'); });
            closePolicyBtn.addEventListener('click', () => { policyModalOverlay.style.display = 'none'; });

            // Cookie Listeners
            acceptCookiesBtn.addEventListener('click', () => {
                localStorage.setItem('cookieConsent', 'true');
                cookieBanner.style.display = 'none';
                gtag('config', 'G-M27LTF4SQG');
            });
            declineCookiesBtn.addEventListener('click', () => {
                localStorage.setItem('cookieConsent', 'false');
                cookieBanner.style.display = 'none';
            });
            
            // Reset Listeners
            confirmResetBtn.addEventListener('click', resetProgress);
            cancelResetBtn.addEventListener('click', () => { resetConfirmModalOverlay.style.display = 'none'; });

            // Other Listeners
            const firstInteraction = () => { initAudio(); document.body.removeEventListener('click', firstInteraction); document.body.removeEventListener('touchstart', firstInteraction); };
            document.body.addEventListener('click', firstInteraction);
            document.body.addEventListener('touchstart', firstInteraction);
            soundToggle.addEventListener('click', () => { initAudio(); state.isMuted = !state.isMuted; updateUI(); saveData(); });
            themeToggle.addEventListener('click', () => setTheme(state.theme === 'light' ? 'dark' : 'light'));
        }
        
        init();
    </script>
</body>
</html>
