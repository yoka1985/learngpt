<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nonviolent Communication Basics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&display=swap" rel="stylesheet">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-M27LTF4SQG"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      // Config will be called later after consent is given.
    </script>

    <style>
        :root {
            --green: #58cc02;
            --light-green: #89e219;
            --yellow: #ffc800;
            --blue: #1cb0f6;
            --light-blue: #88d4f8;
            --red: #ff4b4b;
            --light-red: #ff8989;
            --border-radius: 16px;
            --button-height: 60px;

            /* Light Theme */
            --bg-primary: #f7f7f7;
            --bg-secondary: #ffffff;
            --text-primary: #4b4b4b;
            --text-secondary: #777777;
            --border-color: #e5e5e5;
            --shadow-color: #00000020;
        }
        
        body.dark-mode {
            /* Dark Theme */
            --bg-primary: #121212;
            --bg-secondary: #1E1E1E;
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --border-color: #333333;
            --shadow-color: #00000040;
        }


        *, *::before, *::after {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 1rem;
            overflow-y: auto;
            transition: background 0.3s, color 0.3s;
        }

        body.rtl { direction: rtl; }

        #app-wrapper {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
        }

        /* --- Header & Progress --- */
        header {
            width: 100%;
            padding: 1rem 0;
            margin-bottom: 1rem;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .xp-display, .lives-display {
            font-weight: 900;
            font-size: 1.2rem;
            color: var(--yellow);
            text-shadow: 1px 1px 2px #00000030;
        }
        .lives-display { color: var(--red); letter-spacing: 0.2em; }
        .header-left, .header-right { display: flex; align-items: center; gap: 1rem; }

        .sound-toggle, .theme-toggle, .lang-toggle {
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-secondary);
        }
        .lang-toggle.active { color: var(--blue); text-decoration: underline;}


        .progress-bar-container {
            width: 100%;
            height: 20px;
            background-color: var(--border-color);
            border-radius: 10px;
            border: 2px solid var(--border-color);
            overflow: hidden;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--light-blue), var(--blue));
            border-radius: 8px;
            transition: width 0.5s ease-out;
        }
        
        /* --- Main Content & Map --- */
        #content-area {
            flex-grow: 1;
            width: 100%;
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 24px #0000001a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 400px;
            transition: background 0.3s, border-color 0.3s;
        }

        .map-view {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
            padding: 2rem 0;
        }

        .stage-node { position: relative; }

        .stage-button {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 8px solid var(--bg-secondary);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1), 0 4px 0 var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s, color 0.3s;
        }
        .stage-button:active {
            transform: translateY(2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1), 0 2px 0 var(--border-color);
        }

        .stage-icon { font-size: 2.5rem; }
        .stage-title-map { font-size: 0.9rem; margin-top: 5px; }

        .stage-button.unlocked { background: var(--blue); color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1), 0 4px 0 #0d7ab3; animation: pulse 1.5s infinite; }
        .stage-button.completed { background: var(--green); color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1), 0 4px 0 #3a8a00; }
        .stage-button.locked { background: var(--border-color); color: var(--text-secondary); cursor: not-allowed; }
        
        .giraffe-map-icon { position: absolute; width: 60px; height: 60px; bottom: -30px; left: -50px; transform: rotate(-15deg); transition: all 0.5s ease-in-out; }
        body.rtl .giraffe-map-icon { left: auto; right: -50px; transform: rotate(15deg); }
        
        .level-title { width: 100%; text-align: center; font-size: 1.5rem; font-weight: 900; color: var(--text-secondary); padding-bottom: 1rem; margin-bottom: 2rem; border-bottom: 2px solid var(--border-color); }

        .screen-title, .completion-title { font-size: 1.8rem; font-weight: 900; text-align: center; margin-bottom: 1.5rem; }
        .completion-icon { font-size: 4rem; animation: bounce-in 0.5s ease-out; }
        .lesson-content, .exercise-question { font-size: 1.1rem; line-height: 1.6; text-align: center; margin-bottom: 2rem; }
        .lesson-example { width: 100%; padding: 1rem; background: var(--bg-primary); border-left: 5px solid var(--blue); border-radius: 8px; margin-top: 1.5rem; font-style: italic; transition: background 0.3s; }
        body.rtl .lesson-example { border-left: none; border-right: 5px solid var(--blue); }

        .btn { display: flex; align-items: center; justify-content: center; width: 100%; min-height: var(--button-height); font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 1.1rem; color: var(--text-primary); background-color: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: var(--border-radius); cursor: pointer; padding: 0.5rem 1rem; text-align: center; box-shadow: 0 4px 0 var(--shadow-color); transition: all 0.2s ease; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 0 var(--shadow-color); }
        .btn:active:not(:disabled) { transform: translateY(2px); box-shadow: 0 2px 0 var(--shadow-color); }
        .btn:disabled { cursor: not-allowed; color: var(--text-secondary); }
        .btn-primary { background-color: var(--green); color: white; border-color: var(--green); box-shadow: 0 4px 0 #3a8a00; }
        .btn-primary:hover:not(:disabled) { background-color: var(--light-green); border-color: var(--light-green); }
        .btn.correct { background-color: var(--green); border-color: var(--green); color: white; animation: bounce 0.5s; }
        .btn.incorrect { background-color: var(--light-red); border-color: var(--light-red); color: white; }
        
        footer { width: 100%; position: relative; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        
        .giraffe-container { display: flex; align-items: flex-end; gap: 10px; margin-top: 1rem; }
        #giraffe-svg-container { width: 80px; height: auto; flex-shrink: 0; display: flex; justify-content: center; align-items: flex-end; }
        .speech-bubble { position: relative; background: var(--bg-secondary); border-radius: var(--border-radius); padding: 1rem; font-weight: 700; box-shadow: 0 4px 0 var(--shadow-color); border: 1px solid var(--border-color); width: 100%; }
        .speech-bubble::before { content: ''; position: absolute; left: -10px; bottom: 15px; width: 0; height: 0; border: 10px solid transparent; border-right-color: var(--bg-secondary); border-left: 0; border-bottom: 0; margin-top: -5px; margin-left: -10px; transition: border-right-color 0.3s; }
        body.rtl .speech-bubble::before { left: auto; right: -10px; border-right-color: transparent; border-left-color: var(--bg-secondary); border-right: 0; border-left: 10px; margin-left: 0; margin-right: -10px; transition: border-left-color 0.3s; }
        
        #feedback-section { width: 100%; text-align: center; padding: 1rem; }
        .feedback-message { min-height: 80px; border-radius: var(--border-radius); padding: 1rem; margin-bottom: 1rem; font-weight: 700; font-size: 1.2rem; display: none; }
        .feedback-message.correct { display: block; background: #e1f9d3; color: #3a8a00; border-left: 5px solid var(--green); }
        .feedback-message.incorrect { display: block; background: #ffebee; color: #c00c00; border-left: 5px solid var(--red); }
        body.dark-mode .feedback-message.correct { background: #2c4a27; color: #b2d8b2; }
        body.dark-mode .feedback-message.incorrect { background: #5c2c2c; color: #f2c2c2; }
        body.rtl .feedback-message.correct, body.rtl .feedback-message.incorrect { border-left: none; border-right: 5px solid var(--green); }
        body.rtl .feedback-message.incorrect { border-right-color: var(--red); }
        #next-button-container { margin-top: 1rem; width: 100%; max-width: 300px; }

        .matching-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; width:100%; }
        .matching-pair { min-height: var(--button-height); display: flex; align-items: center; justify-content: center; padding: 0.75rem; background: var(--bg-secondary); transition: background 0.3s; border: 2px solid var(--border-color); border-radius: var(--border-radius); box-shadow: 0 4px 0 var(--shadow-color); cursor: grab; user-select: none; font-weight: 700; text-align: center; }
        .matching-pair.selected { background: var(--blue); color: white; border-color: var(--blue); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem;}
        .modal { background: var(--bg-secondary); padding: 2rem; border-radius: var(--border-radius); max-width: 90%; width: 400px; text-align: center; animation: bounce-in 0.4s; }
        .modal h3 { margin-top: 0; color: var(--blue); }
        .modal .btn { margin-top: 1rem; }
        .modal .selection-group { margin: 1.5rem 0; }
        .modal .selection-group p { font-weight: 700; margin-bottom: 0.5rem; }
        .modal .btn-group { display: flex; gap: 1rem; justify-content: center;}
        .modal .btn-group .btn { width: auto; padding: 0.5rem 1.5rem; }
        .modal .btn-group .btn.active { background-color: var(--blue); color: white; }
        #policy-text { text-align: left; max-height: 300px; overflow-y: auto; font-size: 0.9rem; }
        #policy-text a { color: var(--blue); }

        #cookie-consent-banner { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-secondary); padding: 1rem; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: none; align-items: center; justify-content: center; gap: 1rem; z-index: 2000; text-align: center; flex-wrap: wrap; }
        #cookie-consent-banner p { margin: 0 1rem 0.5rem 1rem; flex-basis: 100%; }
        #cookie-consent-banner .cookie-buttons { display: flex; gap: 1rem; }
        
        .footer-content { text-align: center; }
        .footer-links { margin-bottom: 1rem; }
        .footer-links a, .footer-links button { color: var(--text-secondary); text-decoration: none; margin: 0 0.5rem; font-size: 0.8rem; background: none; border: none; cursor: pointer; padding: 0; }
        .footer-links a:hover, .footer-links button:hover { text-decoration: underline; }
        .completion-actions { margin-top: 1.5rem; display: flex; flex-direction: column; align-items: center; gap: 1rem; width: 100%; max-width: 300px;}
        #reset-progress-btn { font-size: 0.8rem; color: var(--text-secondary); text-decoration: underline; background: none; border: none; cursor: pointer;}

        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes bounce-in { 0% { transform: scale(0.7); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .confetti { position: fixed; top: -10px; width: 10px; height: 10px; opacity: 0.8; animation: fall 3s linear infinite; }
        @keyframes fall { to { transform: translateY(100vh); opacity: 0; } }
        
        @media (max-width: 600px) { body { padding: 0.5rem; } #content-area { padding: 1rem; } .screen-title { font-size: 1.5rem; } .lesson-content, .exercise-question { font-size: 1rem; } .btn { font-size: 1rem; } .matching-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="welcome-modal-overlay" class="modal-overlay">
        <div class="modal">
            <h3 id="welcome-title"></h3>
            <p id="welcome-text"></p>

            <div class="selection-group">
                 <p id="lang-select-label">Language</p>
                 <div class="btn-group">
                    <button id="lang-btn-en" class="btn active">English</button>
                    <button id="lang-btn-he" class="btn">×¢×‘×¨×™×ª</button>
                 </div>
            </div>

            <button id="start-course-btn" class="btn btn-primary"></button>
        </div>
    </div>
    
    <div id="policy-modal-overlay" class="modal-overlay">
        <div class="modal">
            <h3 id="policy-title"></h3>
            <div id="policy-text"></div>
            <button id="close-policy-btn" class="btn btn-primary"></button>
        </div>
    </div>
    
    <div id="reset-confirm-modal-overlay" class="modal-overlay">
        <div class="modal">
            <h3 id="reset-confirm-title"></h3>
            <p id="reset-confirm-text"></p>
            <div class="btn-group">
                <button id="confirm-reset-btn" class="btn"></button>
                <button id="cancel-reset-btn" class="btn btn-primary"></button>
            </div>
        </div>
    </div>
   
    <div id="app-wrapper">
        <header>
            <div class="header-controls">
                <div class="header-left">
                     <div class="xp-display">â¤ï¸ 0</div>
                </div>
                <div class="header-right">
                    <div id="lives-display" class="lives-display"></div>
                    <button id="theme-toggle" class="theme-toggle">ğŸŒ™</button>
                    <button id="sound-toggle" class="sound-toggle">ğŸ”Š</button>
                </div>
            </div>
            <div class="progress-bar-container">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
        </header>

        <main id="content-area"></main>

        <footer>
            <div class="footer-content">
                <div class="footer-links">
                    <a href="#" id="support-link" target="_blank"></a>
                    <a href="#" id="terms-link"></a>
                    <a href="#" id="privacy-link"></a>
                </div>
                <div class="giraffe-container">
                    <div id="giraffe-svg-container">
                        <!-- Giraffe SVG will be injected here by JavaScript -->
                    </div>
                    <div id="giraffe-speech" class="speech-bubble"></div>
                </div>
            </div>
        </footer>
    </div>
    
    <div id="cookie-consent-banner">
        <p id="cookie-text"></p>
        <div class="cookie-buttons">
            <button id="accept-cookies-btn" class="btn btn-primary"></button>
            <button id="decline-cookies-btn" class="btn"></button>
        </div>
    </div>
    
    <script>
        const contentArea = document.getElementById('content-area');
        const progressBar = document.getElementById('progress-bar');
        const xpDisplay = document.querySelector('.xp-display');
        const livesDisplay = document.getElementById('lives-display');
        const soundToggle = document.getElementById('sound-toggle');
        const themeToggle = document.getElementById('theme-toggle');
        const giraffeSpeech = document.getElementById('giraffe-speech');
        const giraffeSvgContainer = document.getElementById('giraffe-svg-container');
        
        // Modal elements
        const welcomeModalOverlay = document.getElementById('welcome-modal-overlay');
        const welcomeTitle = document.getElementById('welcome-title');
        const welcomeText = document.getElementById('welcome-text');
        const langSelectLabel = document.getElementById('lang-select-label');
        const langBtnEn = document.getElementById('lang-btn-en');
        const langBtnHe = document.getElementById('lang-btn-he');
        const startCourseBtn = document.getElementById('start-course-btn');

        // Policy Modal
        const policyModalOverlay = document.getElementById('policy-modal-overlay');
        const policyTitle = document.getElementById('policy-title');
        const policyText = document.getElementById('policy-text');
        const closePolicyBtn = document.getElementById('close-policy-btn');

        // Reset Confirm Modal
        const resetConfirmModalOverlay = document.getElementById('reset-confirm-modal-overlay');
        const resetConfirmTitle = document.getElementById('reset-confirm-title');
        const resetConfirmText = document.getElementById('reset-confirm-text');
        const confirmResetBtn = document.getElementById('confirm-reset-btn');
        const cancelResetBtn = document.getElementById('cancel-reset-btn');

        // Cookie Banner
        const cookieBanner = document.getElementById('cookie-consent-banner');
        const cookieText = document.getElementById('cookie-text');
        const acceptCookiesBtn = document.getElementById('accept-cookies-btn');
        const declineCookiesBtn = document.getElementById('decline-cookies-btn');

        // Footer Links
        const supportLink = document.getElementById('support-link');
        const termsLink = document.getElementById('terms-link');
        const privacyLink = document.getElementById('privacy-link');

        // --- Giraffe SVGs representing growth ---
        const giraffeSVGs = [
            // Stage 0: Baby
            `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M58 83C58 88.5228 54.5228 93 50 93C45.4772 93 42 88.5228 42 83C42 77.4772 45.4772 73 50 73C54.5228 73 58 77.4772 58 83Z" fill="#FBBF24"/><path d="M45 52C45 50.3431 46.3431 49 48 49H52C53.6569 49 55 50.3431 55 52V73H45V52Z" fill="#FCD34D"/><path d="M51.5 39C51.5 35.6863 48.8137 33 45.5 33C42.1863 33 39.5 35.6863 39.5 39V50H51.5V39Z" fill="#FCD34D"/><circle cx="43" cy="40" r="2" fill="black"/><path d="M41 33C41 31.8954 41.8954 31 43 31H44C45.1046 31 46 31.8954 46 33V35H41V33Z" fill="#D97706"/><path d="M49 33C49 31.8954 49.8954 31 51 31H52C53.1046 31 54 31.8954 54 33V35H49V33Z" fill="#D97706"/><circle cx="47" cy="60" r="3" fill="#F59E0B"/><circle cx="53" cy="77" r="4" fill="#F59E0B"/></svg>`,
            // Stage 1: Toddler
            `<svg viewBox="0 0 100 110" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M60 90C60 95.5228 56.5228 100 52 100C47.4772 100 44 95.5228 44 90C44 84.4772 47.4772 80 52 80C56.5228 80 60 84.4772 60 90Z" fill="#FBBF24"/><path d="M47 50C47 48.3431 48.3431 47 50 47H54C55.6569 47 57 48.3431 57 50V80H47V50Z" fill="#FCD34D"/><path d="M53.5 32C53.5 28.6863 50.8137 26 47.5 26C44.1863 26 41.5 28.6863 41.5 32V48H53.5V32Z" fill="#FCD34D"/><circle cx="45" cy="33" r="2" fill="black"/><path d="M43 26C43 24.8954 43.8954 24 45 24H46C47.1046 24 48 24.8954 48 26V28H43V26Z" fill="#D97706"/><path d="M51 26C51 24.8954 51.8954 24 53 24H54C55.1046 24 56 24.8954 56 26V28H51V26Z" fill="#D97706"/><circle cx="49" cy="65" r="3.5" fill="#F59E0B"/><circle cx="55" cy="84" r="4.5" fill="#F59E0B"/><circle cx="49" cy="93" r="3" fill="#F59E0B"/></svg>`,
            // Stage 2: Youth
            `<svg viewBox="0 0 100 120" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M62 97C62 102.523 58.5228 107 54 107C49.4772 107 46 102.523 46 97C46 91.4772 49.4772 87 54 87C58.5228 87 62 91.4772 62 97Z" fill="#FBBF24"/><path d="M49 48C49 46.3431 50.3431 45 52 45H56C57.6569 45 59 46.3431 59 48V87H49V48Z" fill="#FCD34D"/><path d="M55.5 25C55.5 21.6863 52.8137 19 49.5 19C46.1863 19 43.5 21.6863 43.5 25V46H55.5V25Z" fill="#FCD34D"/><circle cx="47" cy="26" r="2" fill="black"/><path d="M45 19C45 17.8954 45.8954 17 47 17H48C49.1046 17 50 17.8954 50 19V21H45V19Z" fill="#D97706"/><path d="M53 19C53 17.8954 53.8954 17 55 17H56C57.1046 17 58 17.8954 58 19V21H53V19Z" fill="#D97706"/><circle cx="51" cy="70" r="4" fill="#F59E0B"/><circle cx="57" cy="91" r="5" fill="#F59E0B"/><circle cx="51" cy="55" r="3" fill="#F59E0B"/></svg>`,
             // Stage 3 & 4: Teen / Adult
            `<svg viewBox="0 0 100 130" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M64 104C64 109.523 60.5228 114 56 114C51.4772 114 48 109.523 48 104C48 98.4772 51.4772 94 56 94C60.5228 94 64 98.4772 64 104Z" fill="#FBBF24"/><path d="M51 46C51 44.3431 52.3431 43 54 43H58C59.6569 43 61 44.3431 61 46V94H51V46Z" fill="#FCD34D"/><path d="M57.5 18C57.5 14.6863 54.8137 12 51.5 12C48.1863 12 45.5 14.6863 45.5 18V44H57.5V18Z" fill="#FCD34D"/><circle cx="49" cy="19" r="2" fill="black"/><path d="M47 12C47 10.8954 47.8954 10 49 10H50C51.1046 10 52 10.8954 52 12V14H47V12Z" fill="#D97706"/><path d="M55 12C55 10.8954 55.8954 10 57 10H58C59.1046 10 60 10.8954 60 12V14H55V12Z" fill="#D97706"/><circle cx="53" cy="75" r="4" fill="#F59E0B"/><circle cx="59"cy="98" r="5" fill="#F59E0B"/><circle cx="53" cy="58" r="3.5" fill="#F59E0B"/><circle cx="58" cy="108" r="3" fill="#F59E0B"/></svg>`
        ];

        let audioCtx;
        function initAudio() { if (!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch (e) { console.error("Web Audio API not supported."); } } }
        function playSound(type) {
            if (!audioCtx || state.isMuted) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            if (type === 'correct') { o.type = 'sine'; o.frequency.setValueAtTime(600, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1); g.gain.setValueAtTime(0.2, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.2); o.start(); o.stop(audioCtx.currentTime + 0.2); }
            else if (type === 'incorrect') { o.type = 'square'; o.frequency.setValueAtTime(200, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2); g.gain.setValueAtTime(0.2, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.3); o.start(); o.stop(audioCtx.currentTime + 0.3); }
            else if (type === 'streak' || type === 'moduleComplete') { const notes = type === 'streak' ? [600, 750, 900] : [523, 659, 783, 1046]; g.gain.setValueAtTime(0.15, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5); notes.forEach((n, i) => { const o2 = audioCtx.createOscillator(); o2.connect(g); o2.type = 'triangle'; o2.frequency.setValueAtTime(n, audioCtx.currentTime + i * 0.1); o2.start(audioCtx.currentTime + i * 0.1); o2.stop(audioCtx.currentTime + i * 0.1 + 0.1); }); }
        }

        let state = {};
        const defaultState = {
            view: 'map',
            lang: 'en',
            theme: 'light',
            activeModule: { id: null, screen: 0, lives: 3 },
            xp: 0,
            streak: 0,
            isMuted: false,
            completedModules: []
        };
        
        // --- NVC COURSE DATA with Hebrew translation ---
        const courseContent = {
            en: {
                welcomeTitle: "Welcome to Compassionate Communication!",
                welcomeText: "Join me on a journey to learn Nonviolent Communication (NVC). We'll learn to connect more deeply with ourselves and others.",
                langSelectLabel: "Language",
                letsGo: "Let's Begin ğŸŒ±",
                gotIt: "Got it!",
                mapSpeech: "Wonderful! When you're ready, select the next step on our path.",
                stageSpeech: "Let's look at this together.",
                moduleComplete: "Step Complete!",
                outOfTries: "It's okay to stumble.",
                outOfTriesMsg: "That was tricky! Every attempt is a chance to learn. Let's try this step again from the beginning.",
                tryAgain: "Try Again",
                continue: "Continue",
                continueToMap: "Continue to Map",
                level1Title: "The Path of NVC",
                finalTitle: "You've learned the core path! ğŸ‰",
                finalContent: "Congratulations! You've walked through the four steps of NVC. You now have the tools to express yourself honestly and listen with compassion. This is a lifelong practice.",
                finalBot: "Your heart is speaking so clearly! ğŸ’–",
                feedbackCTA: "Give Feedback & Get Updates",
                supportProject: "Support this project",
                terms: "Terms of Use",
                privacy: "Privacy Policy",
                resetProgress: "Reset Progress",
                cookieText: "We use cookies to improve your experience and analyze site traffic.",
                accept: "Accept",
                decline: "Decline",
                close: "Close",
                resetConfirmTitle: "Are you sure?",
                resetConfirmText: "This will permanently delete all your progress.",
                confirmReset: "Yes, Reset",
                cancel: "Cancel",
            },
            he: {
                welcomeTitle: "×‘×¨×•×›×™× ×”×‘××™× ×œ×ª×§×©×•×¨×ª ××§×¨×‘×ª!",
                welcomeText: "×”×¦×˜×¨×¤×• ××œ×™×™ ×œ××¡×¢ ×œ×œ×™××•×“ ×ª×§×©×•×¨×ª ××§×¨×‘×ª (NVC). × ×œ××“ ×œ×”×ª×—×‘×¨ ×œ×¢×¦×× ×• ×•×œ××—×¨×™× ×‘××•×¤×Ÿ ×¢××•×§ ×™×•×ª×¨.",
                langSelectLabel: "×©×¤×”",
                letsGo: "×‘×•××• × ×ª×—×™×œ ğŸŒ±",
                gotIt: "×”×‘× ×ª×™!",
                mapSpeech: "× ×”×“×¨! ×›×©×ª×”×™×• ××•×›× ×™×, ×‘×—×¨×• ××ª ×”×¦×¢×“ ×”×‘× ×‘×“×¨×›× ×•.",
                stageSpeech: "×‘×•××• × ×‘×—×Ÿ ××ª ×–×” ×™×—×“.",
                moduleComplete: "×”×©×œ×‘ ×”×•×©×œ×!",
                outOfTries: "×–×” ×‘×¡×“×¨ ×œ××¢×•×“.",
                outOfTriesMsg: "×–×” ×”×™×” ×××ª×’×¨! ×›×œ × ×™×¡×™×•×Ÿ ×”×•× ×”×–×“×× ×•×ª ×œ×œ××•×“. ×‘×•××• × × ×¡×” ××ª ×”×©×œ×‘ ×”×–×” ×©×•×‘ ××”×”×ª×—×œ×”.",
                tryAgain: "×œ× ×¡×•×ª ×©×•×‘",
                continue: "×”××©×š",
                continueToMap: "×”××©×š ×œ××¤×”",
                level1Title: "×”×©×‘×™×œ ×©×œ ×ª×§×©×•×¨×ª ××§×¨×‘×ª",
                finalTitle: "×œ××“×ª× ××ª ×©×‘×™×œ ×”×œ×™×‘×”! ğŸ‰",
                finalContent: "×›×œ ×”×›×‘×•×“! ×¢×‘×¨×ª× ×“×¨×š ××¨×‘×¢×ª ×”×¦×¢×“×™× ×©×œ ×ª×§×©×•×¨×ª ××§×¨×‘×ª. ×›×¢×ª ×™×© ×œ×›× ×›×œ×™× ×œ×”×‘×™×¢ ××ª ×¢×¦××›× ×‘×›× ×•×ª ×•×œ×”×§×©×™×‘ ×‘×—××œ×”. ×–×•×”×™ ×“×¨×š ×—×™×™×.",
                finalBot: "×”×œ×‘ ×©×œ×›× ××“×‘×¨ ×›×œ ×›×š ×‘×¨×•×¨! ï¿½",
                feedbackCTA: "××ª×Ÿ ××©×•×‘ ×•×§×‘×œ×ª ×¢×“×›×•× ×™×",
                supportProject: "×ª××›×• ×‘×¤×¨×•×™×§×˜",
                terms: "×ª× ××™ ×©×™××•×©",
                privacy: "××“×™× ×™×•×ª ×¤×¨×˜×™×•×ª",
                resetProgress: "××™×¤×•×¡ ×”×ª×§×“××•×ª",
                cookieText: "×× ×• ××©×ª××©×™× ×‘×¢×•×’×™×•×ª (cookies) ×›×“×™ ×œ×©×¤×¨ ××ª ×—×•×•×™×ª ×”××©×ª××© ×•×œ× ×ª×— ××ª ×ª×¢×‘×•×¨×ª ×”××ª×¨.",
                accept: "××™×©×•×¨",
                decline: "×¡×™×¨×•×‘",
                close: "×¡×’×™×¨×”",
                resetConfirmTitle: "×”×× ××ª× ×‘×˜×•×—×™×?",
                resetConfirmText: "×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”×”×ª×§×“××•×ª ×©×œ×›× ×œ×¦××™×ª×•×ª.",
                confirmReset: "×›×Ÿ, ××¤×¡×•",
                cancel: "×‘×™×˜×•×œ",
            }
        };

        const modules = [
            { id: 1, title: {en: "Observations", he: "×”×‘×—× ×•×ª"}, icon: "ğŸ‘€", screens: [
                { type: 'lesson', title: {en: "Meet the Giraffe", he: "×”×›×™×¨×• ××ª ×”×’'×™×¨×£"}, content: { en: "In NVC, the giraffe symbolizes compassionate communication. It has a long neck to see from a clear perspective and a big heart. I'll be your guide!", he: "×‘×ª×§×©×•×¨×ª ××§×¨×‘×ª, ×”×’'×™×¨×£ ××¡××œ ×ª×§×©×•×¨×ª ×—×•××œ×ª. ×™×© ×œ×• ×¦×•×•××¨ ××¨×•×š ×›×“×™ ×œ×¨××•×ª ××¤×¨×¡×¤×§×˜×™×‘×” ×¨×—×‘×” ×•×œ×‘ ×’×“×•×œ. ×× ×™ ××”×™×” ×”××“×¨×™×š ×©×œ×›×!" } },
                { type: 'lesson', title: {en: 'Observation vs. Evaluation', he: '×”×‘×—× ×” ××•×œ ×”×¢×¨×›×”'}, content: {en: "The first step is to observe what is actually happening, free of judgment. We state facts, like a camera.", he: "×”×¦×¢×“ ×”×¨××©×•×Ÿ ×”×•× ×œ×”×‘×—×™×Ÿ ×‘××” ×©×§×•×¨×” ×‘×¤×•×¢×œ, ×œ×œ× ×©×™×¤×•×˜. ×× ×—× ×• ××¦×™×™× ×™× ×¢×•×‘×“×•×ª, ×›××™×œ×• ×”×™×™× ×• ××¦×œ××”."}, example: {en: "Evaluation: 'You're so messy.'\nObservation: 'I see socks on the floor.'", he: "×”×¢×¨×›×”: '××ª×” ×›×œ ×›×š ××‘×•×œ×’×Ÿ.'\n×”×‘×—× ×”: '×× ×™ ×¨×•××” ×’×¨×‘×™×™× ×¢×œ ×”×¨×¦×¤×”.'"} },
                { type: 'exercise', subType: 'ab-test', question: {en:"Which is an observation?", he: "××™×–×• ×××™×¨×” ×”×™× ×”×‘×—× ×”?"}, options: [{text: {en:'You never listen.', he: '××ª×” ××£ ×¤×¢× ×œ× ××§×©×™×‘.'}, correct: false}, {text: {en:'You were looking at your phone while I was talking.', he: '×”×¡×ª×›×œ×ª ×‘×˜×œ×¤×•×Ÿ ×©×œ×š ×›×©×“×™×‘×¨×ª×™.'}, correct: true}], feedback: {correct: {en:"Exactly! That describes a specific action without judgment.", he: "×‘×“×™×•×§! ×–×” ××ª××¨ ×¤×¢×•×œ×” ×¡×¤×¦×™×¤×™×ª ×œ×œ× ×©×™×¤×•×˜."}, incorrect: {en:"'Never' is an evaluation. The other option states what was seen.", he: "'××£ ×¤×¢×' ×”×™× ×”×¢×¨×›×”. ×”××¤×©×¨×•×ª ×”×©× ×™×™×” ××¦×™×™× ×ª ××” ×©× ×¨××”."}} },
                { type: 'lesson', title: {en: 'Avoiding Generalizations', he: '×”×™×× ×¢×•×ª ××”×›×œ×œ×•×ª'}, content: {en: "Words like 'always,' 'never,' 'often,' or 'seldom' usually signal an evaluation disguised as an observation.", he: "××™×œ×™× ×›××• '×ª××™×“', '××£ ×¤×¢×', '×œ×¢×™×ª×™× ×§×¨×•×‘×•×ª' ××• '×œ×¤×¢××™×' ×‘×“×¨×š ×›×œ×œ ××¡×× ×•×ª ×”×¢×¨×›×” ×”××—×•×¤×©×ª ×œ×”×‘×—× ×”."}, example: {en:"Evaluation: 'You are always late.'\nObservation: 'The last three times we met, you arrived after our agreed time.'", he:"×”×¢×¨×›×”: '××ª×” ×ª××™×“ ×××—×¨.'\n×”×‘×—× ×”: '×‘×©×œ×•×© ×”×¤×¢××™× ×”××—×¨×•× ×•×ª ×©× ×¤×’×©× ×•, ×”×’×¢×ª ××—×¨×™ ×”×©×¢×” ×©×§×‘×¢× ×•.'"} },
                { type: 'exercise', subType: 'mcq', question: {en:"Which word signals an evaluation?", he: "××™×–×• ××™×œ×” ××¡×× ×ª ×”×¢×¨×›×”?"}, options: [{text: {en:'always', he: '×ª××™×“'}, correct: true}, {text: {en:'saw', he: '×¨××™×ª×™'}, correct: false}, {text: {en:'heard', he: '×©××¢×ª×™'}, correct: false}], feedback: {correct: {en:"Correct! Generalizations like 'always' are evaluations.", he: "× ×›×•×Ÿ! ×”×›×œ×œ×•×ª ×›××• '×ª××™×“' ×”×Ÿ ×”×¢×¨×›×•×ª."}, incorrect: {en:"'Saw' and 'heard' point to direct observations.", he: "'×¨××™×ª×™' ×•'×©××¢×ª×™' ××¦×‘×™×¢×•×ª ×¢×œ ×”×‘×—× ×•×ª ×™×©×™×¨×•×ª."}} },
                { type: 'lesson', title: {en: 'Quotes as Observations', he: '×¦×™×˜×•×˜×™× ×›×”×‘×—× ×•×ª'}, content: {en: "Quoting someone directly is a very powerful form of observation. It removes interpretation.", he: "×œ×¦×˜×˜ ××™×©×”×• ×™×©×™×¨×•×ª ×–×• ×¦×•×¨×” ×—×–×§×” ×××•×“ ×©×œ ×”×‘×—× ×”. ×–×” ××¡×™×¨ ×¤×¨×©× ×•×ª."}, example: {en:"Interpretation: 'He was angry.'\nObservation: 'He said, \"I am so frustrated right now!\" in a loud voice.'", he:"×¤×¨×©× ×•×ª: '×”×•× ×›×¢×¡.'\n×”×‘×—× ×”: '×”×•× ×××¨, \"×× ×™ ×›×œ ×›×š ××ª×•×¡×›×œ ×¢×›×©×™×•!\" ×‘×§×•×œ ×¨×.'"} },
                { type: 'exercise', subType: 'ab-test', question: {en:"Which is a better observation?", he: "××™×–×• ×”×‘×—× ×” ×˜×•×‘×” ×™×•×ª×¨?"}, options: [{text: {en:'You were rude.', he: '×”×™×™×ª ×’×¡ ×¨×•×—.'}, correct: false}, {text: {en:"You said 'That's a stupid idea.'", he: '×××¨×ª "×–×” ×¨×¢×™×•×Ÿ ×˜×™×¤×©×™".'}, correct: true}], feedback: {correct: {en:"Exactly. Quoting is precise.", he: "×‘×“×™×•×§. ×¦×™×˜×•×˜ ×”×•× ××“×•×™×§."}, incorrect: {en:"'Rude' is a judgment. Quoting the exact words is an observation.", he: "'×’×¡ ×¨×•×—' ×–×” ×©×™×¤×•×˜. ×¦×™×˜×•×˜ ×”××™×œ×™× ×”××“×•×™×§×•×ª ×”×•× ×”×‘×—× ×”."}} },
                { type: 'exercise', subType: 'matching', question: {en: "Match the statement to its type.", he: "×”×ª×× ××ª ×”×××™×¨×” ×œ×¡×•×’ ×©×œ×”."}, pairs: [{item1: {en: "He is generous.", he: "×”×•× × ×“×™×‘."}, item2: {en: "Evaluation", he: "×”×¢×¨×›×”"}}, {item1: {en: "She arrived at 9:05.", he: "×”×™× ×”×’×™×¢×” ×‘-9:05."}, item2: {en: "Observation", he: "×”×‘×—× ×”"}}, {item1: {en: "You work too much.", he: "××ª×” ×¢×•×‘×“ ×™×•×ª×¨ ××“×™."}, item2: {en: "Evaluation", he: "×”×¢×¨×›×”"}}], feedback: {correct: {en: "Great job distinguishing between what you see and what you think about it!", he: "×¢×‘×•×“×” × ×”×“×¨×ª ×‘×”×‘×—× ×” ×‘×™×Ÿ ××” ×©××ª× ×¨×•××™× ×œ×‘×™×Ÿ ××” ×©××ª× ×—×•×©×‘×™× ×¢×œ ×–×”!"}, incorrect: {en: "Let's try again. An observation is just the facts, an evaluation adds a judgment.", he: "×‘×•××• × × ×¡×” ×©×•×‘. ×”×‘×—× ×” ×”×™× ×¨×§ ×”×¢×•×‘×“×•×ª, ×”×¢×¨×›×” ××•×¡×™×¤×” ×©×™×¤×•×˜."}} },
            ]},
             { id: 2, title: {en: "Feelings", he: "×¨×’×©×•×ª"}, icon: "â¤ï¸", screens: [
                { type: 'lesson', title: {en: 'Identifying Feelings', he: '×–×™×”×•×™ ×¨×’×©×•×ª'}, content: {en: "The second step is to notice the feelings that arise from our observation. These are emotions within us, not thoughts about others.", he: "×”×¦×¢×“ ×”×©× ×™ ×”×•× ×œ×©×™× ×œ×‘ ×œ×¨×’×©×•×ª ×©×¢×•×œ×™× ××”×”×‘×—× ×” ×©×œ× ×•. ××œ×• ×”×Ÿ ×¨×’×©×•×ª ×‘×ª×•×›× ×•, ×œ× ××—×©×‘×•×ª ×¢×œ ××—×¨×™×."}, example: {en: "Thought disguised as feeling: 'I feel like you don't care.'\nPure feeling: 'I feel sad.'", he: "××—×©×‘×” ××—×•×¤×©×ª ×œ×¨×’×©: '×× ×™ ××¨×’×™×© ×©×œ× ××›×¤×ª ×œ×š.'\n×¨×’×© ×˜×”×•×¨: '×× ×™ ××¨×’×™×© ×¢×¦×•×‘.'"} },
                { type: 'exercise', subType: 'mcq', question: {en: "Which of these is a pure feeling?", he: "××™×–×” ××”×‘××™× ×”×•× ×¨×’×© ×˜×”×•×¨?"}, options: [{text: {en: 'I feel misunderstood.', he: '×× ×™ ××¨×’×™×© ×œ× ××•×‘×Ÿ.'}, correct: false}, {text: {en: 'I feel hurt.', he: '×× ×™ ××¨×’×™×© ×¤×’×•×¢.'}, correct: true}, {text: {en: 'I feel that you should know better.', he: '×× ×™ ××¨×’×™×© ×©×”×™×™×ª ×¦×¨×™×š ×œ×“×¢×ª ×™×•×ª×¨ ×˜×•×‘.'}, correct: false}], feedback: {correct: {en: "Yes, 'hurt' is a feeling word. 'Misunderstood' describes a thought about what someone else is thinking.", he: "×›×Ÿ, '×¤×’×•×¢' ×”×™× ××™×œ×ª ×¨×’×©. '×œ× ××•×‘×Ÿ' ××ª××¨ ××—×©×‘×” ×¢×œ ××” ×©××—×¨×™× ×—×•×©×‘×™×."}, incorrect: {en: "'Hurt' is a pure feeling. 'Misunderstood' is a thought about how someone else sees you.", he: "'×¤×’×•×¢' ×”×•× ×¨×’×© ×˜×”×•×¨. '×œ× ××•×‘×Ÿ' ×”×™× ××—×©×‘×” ×¢×œ ××™×š ××™×©×”×• ××—×¨ ×¨×•××” ××•×ª×š."}} },
                { type: 'lesson', title: {en: 'Feelings vs. Faux Feelings', he: "×¨×’×©×•×ª ××•×œ '×¨×’×©×•×ª ×“××”'"}, content: {en: "Words like 'attacked,' 'abandoned,' or 'betrayed' often imply that someone else did something *to* us. They are thoughts about others' actions, not pure feelings.", he: "××™×œ×™× ×›××• '××•×ª×§×£', '× ×˜×•×©' ××• '× ×‘×’×“' ×œ×¨×•×‘ ××¨××–×•×ª ×©××™×©×”×• ××—×¨ ×¢×©×” ×œ× ×• ××©×”×•. ×”×Ÿ ××—×©×‘×•×ª ×¢×œ ×¤×¢×•×œ×•×ª ×©×œ ××—×¨×™×, ×œ× ×¨×’×©×•×ª ×˜×”×•×¨×™×."}, example: {en: "Faux feeling: 'I feel rejected.'\nPure feeling behind it: 'I feel lonely,' or 'I feel scared.'", he: "×¨×’×© ×“××”: '×× ×™ ××¨×’×™×© ×“×—×•×™.'\n×”×¨×’×© ×”×˜×”×•×¨ ×××—×•×¨×™×•: '×× ×™ ××¨×’×™×© ×‘×•×“×“,' ××• '×× ×™ ××¨×’×™×© ×¤×•×—×“.'"} },
                { type: 'exercise', subType: 'ab-test', question: {en: "Which statement expresses a pure feeling?", he: "××™×–×• ×××™×¨×” ××‘×˜××ª ×¨×’×© ×˜×”×•×¨?"}, options: [{text: {en: 'I feel manipulated.', he: '×× ×™ ××¨×’×™×© ×× ×•×¦×œ.'}, correct: false}, {text: {en: 'I feel disappointed.', he: '×× ×™ ××¨×’×™×© ×××•×›×–×‘.'}, correct: true}], feedback: {correct: {en: "Correct. 'Disappointed' describes your internal experience. 'Manipulated' describes your interpretation of another's actions.", he: "× ×›×•×Ÿ. '×××•×›×–×‘' ××ª××¨ ××ª ×”×—×•×•×™×” ×”×¤× ×™××™×ª ×©×œ×š. '×× ×•×¦×œ' ××ª××¨ ××ª ×”×¤×¨×©× ×•×ª ×©×œ×š ×œ×¤×¢×•×œ×•×ª ×©×œ ××—×¨."}, incorrect: {en: "'Manipulated' is an interpretation of someone's actions. 'Disappointed' is a pure feeling.", he: "'×× ×•×¦×œ' ×”×•× ×¤×¨×©× ×•×ª ×œ×¤×¢×•×œ×•×ª ×©×œ ××™×©×”×• ××—×¨. '×××•×›×–×‘' ×”×•× ×¨×’×© ×˜×”×•×¨."}} },
                { type: 'lesson', title: {en: 'Expanding Your Feelings Vocabulary', he: '×”×¨×—×‘×ª ××•×¦×¨ ×”××™×œ×™× ×©×œ ×”×¨×’×©×•×ª'}, content: {en: "The more words we have for our feelings, the better we can understand ourselves. Are you 'angry,' or are you 'frustrated,' 'irritated,' or 'impatient'?", he: "×›×›×œ ×©×™×© ×œ× ×• ×™×•×ª×¨ ××™×œ×™× ×œ×¨×’×©×•×ª ×©×œ× ×•, ×›×š × ×•×›×œ ×œ×”×‘×™×Ÿ ××ª ×¢×¦×× ×• ×˜×•×‘ ×™×•×ª×¨. ×”×× ××ª×” '×›×•×¢×¡', ××• ×©××•×œ×™ ××ª×” '××ª×•×¡×›×œ', '×¢×¦×‘× ×™' ××• '×—×¡×¨ ×¡×‘×œ× ×•×ª'?"} },
                { type: 'exercise', subType: 'matching', question: {en: "Match the situation to a possible feeling.", he: "×”×ª×× ××ª ×”×¡×™×˜×•××¦×™×” ×œ×¨×’×© ××¤×©×¨×™."}, pairs: [{item1: {en: 'Seeing a friend after a long time', he: '×œ×¨××•×ª ×—×‘×¨ ××—×¨×™ ×”×¨×‘×” ×–××Ÿ'}, item2: {en: 'Joyful', he: '×©××—'}}, {item1: {en: 'Missing a flight', he: '×œ×¤×¡×¤×¡ ×˜×™×¡×”'}, item2: {en: 'Frustrated', he: '××ª×•×¡×›×œ'}}, {item1: {en: 'Receiving a surprise gift', he: '×œ×§×‘×œ ××ª× ×ª ×”×¤×ª×¢×”'}, item2: {en: 'Surprised', he: '××•×¤×ª×¢'}}], feedback: {correct: {en: "Great matches! Connecting situations to feelings is a key step.", he: "×”×ª×××•×ª × ×”×“×¨×•×ª! ×—×™×‘×•×¨ ×‘×™×Ÿ ××¦×‘×™× ×œ×¨×’×©×•×ª ×”×•× ×¦×¢×“ ××¤×ª×—."}, incorrect: {en: "Let's try that again. Think about what emotion might come up in each situation.", he: "×‘×•× × × ×¡×” ×©×•×‘. ×—×©×‘×• ××™×–×• ×ª×—×•×©×” ×™×›×•×œ×” ×œ×¢×œ×•×ª ×‘×›×œ ××¦×‘."}} },
                { type: 'exercise', subType: 'ab-test', question: {en: "Which feeling arises when our needs ARE MET?", he: "××™×–×” ×¨×’×© ×¢×•×œ×” ×›××©×¨ ×”×¦×¨×›×™× ×©×œ× ×• ××ª××œ××™×?"}, options: [{text: {en: 'Peaceful', he: '×©×œ×•×•×”'}, correct: true}, {text: {en: 'Anxious', he: '×—×¨×“×”'}, correct: false}], feedback: {correct: {en: "Yes, feelings like 'peaceful', 'happy', and 'joyful' tell us our needs are being met.", he: "×›×Ÿ, ×¨×’×©×•×ª ×›××• '×©×œ×•×•×”', '×©××—×”' ×•'××•×©×¨' ××•××¨×™× ×œ× ×• ×©×”×¦×¨×›×™× ×©×œ× ×• ××ª××œ××™×."}, incorrect: {en: "'Anxious' points to an unmet need, perhaps for safety or clarity. 'Peaceful' signals met needs.", he: "'×—×¨×“×”' ××¦×‘×™×¢×” ×¢×œ ×¦×•×¨×š ×©×œ× ×”×ª××œ×, ××•×œ×™ ×œ×‘×™×˜×—×•×Ÿ ××• ×‘×”×™×¨×•×ª. '×©×œ×•×•×”' ××¡×× ×ª ×¦×¨×›×™× ×©××•×œ××•."}} },
            ]},
            { id: 3, title: {en: "Needs", he: "×¦×¨×›×™×"}, icon: "ğŸŒ±", screens: [
                { type: 'lesson', title: {en: 'Connecting to Needs', he: '×—×™×‘×•×¨ ×œ×¦×¨×›×™×'}, content: {en: "The third step connects our feelings to universal human needs. Our feelings are messengers telling us what we need.", he: "×”×¦×¢×“ ×”×©×œ×™×©×™ ××—×‘×¨ ××ª ×”×¨×’×©×•×ª ×©×œ× ×• ×œ×¦×¨×›×™× ×× ×•×©×™×™× ××•× ×™×‘×¨×¡×œ×™×™×. ×”×¨×’×©×•×ª ×©×œ× ×• ×”× ×©×œ×™×—×™× ×©××•××¨×™× ×œ× ×• ××” ×× ×—× ×• ×¦×¨×™×›×™×."}, example: {en: "'I feel sad *because I have a need for connection*.'", he: "'×× ×™ ××¨×’×™×© ×¢×¦×•×‘ *×›×™ ×™×© ×œ×™ ×¦×•×¨×š ×‘×—×™×‘×•×¨*.'"} },
                { type: 'lesson', title: {en: 'What Are Needs?', he: '××”× ×¦×¨×›×™×?'}, content: {en: "Needs are universal values like safety, connection, respect, and autonomy. They are common to all people and are never in conflict.", he: "×¦×¨×›×™× ×”× ×¢×¨×›×™× ××•× ×™×‘×¨×¡×œ×™×™× ×›××• ×‘×™×˜×—×•×Ÿ, ×—×™×‘×•×¨, ×›×‘×•×“ ×•××•×˜×•× ×•××™×”. ×”× ××©×•×ª×¤×™× ×œ×›×œ ×‘× ×™ ×”××“× ×•×œ×¢×•×œ× ××™× × ×‘×§×•× ×¤×œ×™×§×˜."}, example: {en: "We all need nourishment, but I might want a salad while you want a pizza.", he: "×›×•×œ× ×• ×¦×¨×™×›×™× ×ª×–×•× ×”, ××‘×œ ×× ×™ ××•×œ×™ ××¨×¦×” ×¡×œ×˜ ×•××ª× ×ª×¨×¦×• ×¤×™×¦×”."} },
                { type: 'exercise', subType: 'ab-test', question: {en: "Which statement connects a feeling to a need?", he: "××™×–×• ×××™×¨×” ××—×‘×¨×ª ×¨×’×© ×œ×¦×•×¨×š?"}, options: [{text: {en: "I'm angry because you ignored me.", he: "×× ×™ ×›×•×¢×¡ ×›×™ ×”×ª×¢×œ××ª ××× ×™."}, correct: false}, {text: {en: "When you looked away, I felt hurt because I need connection.", he: "×›×©×”×¡×˜×ª ××ª ××‘×˜×š, ×”×¨×’×©×ª×™ ×¤×’×•×¢ ×›×™ ×× ×™ ×–×§×•×§ ×œ×—×™×‘×•×¨."}, correct: true}], feedback: {correct: {en: "Beautiful! You connected the feeling ('hurt') to a universal need ('connection'), rather than blaming the other person.", he: "× ×¤×œ×! ×—×™×‘×¨×ª ××ª ×”×¨×’×© ('×¤×’×•×¢') ×œ×¦×•×¨×š ××•× ×™×‘×¨×¡×œ×™ ('×—×™×‘×•×¨'), ×‘××§×•× ×œ×”××©×™× ××ª ×”××“× ×”×©× ×™."}, incorrect: {en: "The best answer connects the feeling to a universal need, not just the other person's action.", he: "×”×ª×©×•×‘×” ×”×˜×•×‘×” ×‘×™×•×ª×¨ ××—×‘×¨×ª ××ª ×”×¨×’×© ×œ×¦×•×¨×š ××•× ×™×‘×¨×¡×œ×™, ×œ× ×¨×§ ×œ×¤×¢×•×œ×” ×©×œ ×”××“× ×”×©× ×™."}} },
                { type: 'lesson', title: {en: 'Needs vs. Strategies', he: '×¦×¨×›×™× ××•×œ ××¡×˜×¨×˜×’×™×•×ª'}, content: {en: "A need is the core value. A strategy is a specific action to meet that need. We often confuse the two.", he: "×¦×•×¨×š ×”×•× ×¢×¨×š ×”×œ×™×‘×”. ××¡×˜×¨×˜×’×™×” ×”×™× ×¤×¢×•×œ×” ×¡×¤×¦×™×¤×™×ª ×›×“×™ ×œ××œ× ××ª ×”×¦×•×¨×š. ×œ×¢×ª×™× ×§×¨×•×‘×•×ª ×× ×• ××‘×œ×‘×œ×™× ×‘×™×Ÿ ×”×©× ×™×™×."}, example: {en: "Strategy: 'I need you to take out the trash.'\nNeed behind it: 'I need support and cooperation.'", he: "××¡×˜×¨×˜×’×™×”: '×× ×™ ×¦×¨×™×š ×©×ª×•×¦×™× ××ª ×”×–×‘×œ.'\n×”×¦×•×¨×š ×××—×•×¨×™ ×–×”: '×× ×™ ×–×§×•×§ ×œ×ª××™×›×” ×•×©×™×ª×•×£ ×¤×¢×•×œ×”.'"} },
                { type: 'exercise', subType: 'mcq', question: {en: "Which of these is a universal need (not a strategy)?", he: "××™×–×” ××”×‘××™× ×”×•× ×¦×•×¨×š ××•× ×™×‘×¨×¡×œ×™ (×œ× ××¡×˜×¨×˜×’×™×”)?"}, options: [{text: {en: 'For you to call me', he: '×©×ª×ª×§×©×¨ ××œ×™×™'}, correct: false}, {text: {en: 'Honesty', he: '×›× ×•×ª'}, correct: true}, {text: {en: 'A vacation', he: '×—×•×¤×©×”'}, correct: false}], feedback: {correct: {en: "That's right! 'Honesty' is a universal value. The others are specific strategies to meet a need.", he: "× ×›×•×Ÿ! '×›× ×•×ª' ×”×•× ×¢×¨×š ××•× ×™×‘×¨×¡×œ×™. ×”××—×¨×™× ×”× ××¡×˜×¨×˜×’×™×•×ª ×¡×¤×¦×™×¤×™×•×ª ×œ××™×œ×•×™ ×¦×¨×›×™×."}, incorrect: {en: "'Honesty' is a universal need. A phone call or a vacation are strategies to meet needs (like connection or rest).", he: "'×›× ×•×ª' ×”×•× ×¦×•×¨×š ××•× ×™×‘×¨×¡×œ×™. ×©×™×—×ª ×˜×œ×¤×•×Ÿ ××• ×—×•×¤×©×” ×”× ××¡×˜×¨×˜×’×™×•×ª ×œ××™×œ×•×™ ×¦×¨×›×™× (×›××• ×—×™×‘×•×¨ ××• ×× ×•×—×”)."}} },
                { type: 'exercise', subType: 'ab-test', question: {en: "Which expresses a need, not a strategy?", he: "××™×–×• ×××™×¨×” ××‘×˜××ª ×¦×•×¨×š, ×œ× ××¡×˜×¨×˜×’×™×”?"}, options: [{text: {en: "I need you to listen to me.", he: "×× ×™ ×¦×¨×™×š ×©×ª×§×©×™×‘ ×œ×™."}, correct: false}, {text: {en: "I need to be heard.", he: "×× ×™ ×¦×¨×™×š ×©×™×©××¢×• ××•×ª×™."}, correct: true}], feedback: {correct: {en: "Precisely. 'To be heard' is the core need. 'For you to listen' is one strategy to meet that need.", he: "×‘×“×™×•×§. '×œ×”×™×•×ª × ×©××¢' ×”×•× ×¦×•×¨×š ×”×œ×™×‘×”. '×©×ª×§×©×™×‘ ×œ×™' ×”×™× ××¡×˜×¨×˜×’×™×” ××—×ª ×œ××œ× ××ª ×”×¦×•×¨×š ×”×–×”."}, incorrect: {en: "'To be heard' is the underlying need. Asking someone to listen is a specific strategy.", he: "'×œ×”×™×•×ª × ×©××¢' ×”×•× ×”×¦×•×¨×š ×”×‘×¡×™×¡×™. ×œ×‘×§×© ×××™×©×”×• ×œ×”×§×©×™×‘ ×–×• ××¡×˜×¨×˜×’×™×” ×¡×¤×¦×™×¤×™×ª."}} },
                { type: 'exercise', subType: 'matching', question: {en: "Connect the feeling to a likely unmet need.", he: "×—×‘×¨ ××ª ×”×¨×’×© ×œ×¦×•×¨×š ×”×¡×‘×™×¨ ×©×œ× ×”×ª××œ×."}, pairs: [{item1: {en: "I feel lonely", he: "×× ×™ ××¨×’×™×© ×‘×•×“×“"}, item2: {en: "Connection", he: "×—×™×‘×•×¨"}}, {item1: {en: "I feel scared", he: "×× ×™ ××¨×’×™×© ×¤×•×—×“"}, item2: {en: "Safety", he: "×‘×™×˜×—×•×Ÿ"}}, {item1: {en: "I feel bored", he: "×× ×™ ××¨×’×™×© ××©×•×¢××"}, item2: {en: "Stimulation", he: "×’×™×¨×•×™"}}], feedback: {correct: {en: "Yes! You're getting to the root of what's alive in you.", he: "×›×Ÿ! ××ª× ××’×™×¢×™× ×œ×©×•×¨×© ×©×œ ××” ×©×—×™ ×‘×›×."}, incorrect: {en: "Take a moment to see what core value is missing when you have that feeling.", he: "×§×—×• ×¨×’×¢ ×œ×¨××•×ª ××™×–×” ×¢×¨×š ×œ×™×‘×” ×—×¡×¨ ×›×©×™×© ×œ×›× ××ª ×”×¨×’×© ×”×–×”."}} },
            ]},
            { id: 4, title: {en: "Requests", he: "×‘×§×©×•×ª"}, icon: "ğŸ—£ï¸", screens: [
                { type: 'lesson', title: {en: "Making Requests", he: "× ×™×¡×•×— ×‘×§×©×•×ª"}, content: {en: "The final step is to make a clear, positive, and doable request for an action to help meet our need. This is a request, not a demand.", he: "×”×©×œ×‘ ×”××—×¨×•×Ÿ ×”×•× ×œ× ×¡×— ×‘×§×©×” ×‘×¨×•×¨×”, ×—×™×•×‘×™×ª ×•×‘×¨×ª-×‘×™×¦×•×¢ ×œ×¤×¢×•×œ×” ×©×ª×¢×–×•×¨ ×œ××œ× ××ª ×”×¦×•×¨×š ×©×œ× ×•. ×–×• ×‘×§×©×”, ×œ× ×“×¨×™×©×”."}, example: {en: "Demand: 'Stop being so loud!'\nRequest: 'Would you be willing to lower your voice?'", he: "×“×¨×™×©×”: '×ª×¤×¡×™×§ ×œ×”×™×•×ª ×›×œ ×›×š ×¨×•×¢×©!'\n×‘×§×©×”: '×”×× ×ª×”×™×” ××•×›×Ÿ ×œ×”× ××™×š ××ª ×§×•×œ×š?'"} },
                { type: 'exercise', subType: 'mcq', question: {en: "Which is a clear and doable request?", he: "××™×–×• ×‘×§×©×” ×”×™× ×‘×¨×•×¨×” ×•×‘×¨×ª-×‘×™×¦×•×¢?"}, options: [{text: {en: 'Be more respectful.', he: '×ª×”×™×” ×™×•×ª×¨ ××›×‘×“.'}, correct: false}, {text: {en: 'Show me you care.', he: '×ª×¨××” ×œ×™ ×©××›×¤×ª ×œ×š.'}, correct: false}, {text: {en: 'Would you be willing to tell me what you heard me say?', he: '×”×× ×ª×”×™×” ××•×›×Ÿ ×œ×•××¨ ×œ×™ ××” ×©××¢×ª ××•×ª×™ ××•××¨?'}, correct: true}], feedback: {correct: {en: "Perfect! That is a specific, concrete action someone can take in the present moment.", he: "××•×©×œ×! ×–×• ×¤×¢×•×œ×” ×¡×¤×¦×™×¤×™×ª ×•××•×—×©×™×ª ×©××™×©×”×• ×™×›×•×œ ×œ×‘×¦×¢ ×‘×¨×’×¢ ×–×”."}, incorrect: {en: "The best requests are for specific actions. 'Be more respectful' is too vague. What action equals respect?", he: "×”×‘×§×©×•×ª ×”×˜×•×‘×•×ª ×‘×™×•×ª×¨ ×”×Ÿ ×œ×¤×¢×•×œ×•×ª ×¡×¤×¦×™×¤×™×•×ª. '×ª×”×™×” ×™×•×ª×¨ ××›×‘×“' ××¢×•×¨×¤×œ ××“×™. ××™×–×• ×¤×¢×•×œ×” ×©×•×•×” ×œ×›×‘×•×“?"}} },
                { type: 'lesson', title: {en: 'Request vs. Demand', he: '×‘×§×©×” ××•×œ ×“×¨×™×©×”'}, content: {en: "A key difference is our willingness to hear 'no'. If we are not open to hearing 'no', our request is actually a demand.", he: "×”×‘×“×œ ××¨×›×–×™ ×”×•× ×”× ×›×•× ×•×ª ×©×œ× ×• ×œ×©××•×¢ '×œ×'. ×× ××™× × ×• ×¤×ª×•×—×™× ×œ×©××•×¢ '×œ×', ×”×‘×§×©×” ×©×œ× ×• ×”×™× ×œ××¢×©×” ×“×¨×™×©×”."} },
                { type: 'exercise', subType: 'ab-test', question: {en: "Which is more likely to be heard as a request, not a demand?", he: "××™×–×• ×××™×¨×” ×¦×¤×•×™×” ×œ×”×™×©××¢ ×›×‘×§×©×”, ×œ× ×›×“×¨×™×©×”?"}, options: [{text: {en: 'You need to take out the trash now.', he: '××ª×” ×¦×¨×™×š ×œ×”×•×¦×™× ××ª ×”×–×‘×œ ×¢×›×©×™×•.'}, correct: false}, {text: {en: 'Would you be willing to take out the trash?', he: '×”×× ×ª×”×™×” ××•×›×Ÿ ×œ×”×•×¦×™× ××ª ×”×–×‘×œ?'}, correct: true}], feedback: {correct: {en: "Exactly. Phrasing it as a 'Would you be willing...?' question opens the door for connection, even if the answer is no.", he: "×‘×“×™×•×§. × ×™×¡×•×— ×›×©××œ×” '×”×× ×ª×”×™×” ××•×›×Ÿ...?' ×¤×•×ª×— ×“×œ×ª ×œ×—×™×‘×•×¨, ×’× ×× ×”×ª×©×•×‘×” ×”×™× ×œ×."}, incorrect: {en: "Using phrases like 'Would you be willing...?' invites cooperation, whereas 'You need to...' can sound like a demand.", he: "×©×™××•×© ×‘×‘×™×˜×•×™×™× ×›××• '×”×× ×ª×”×™×” ××•×›×Ÿ...?' ××–××™×Ÿ ×©×™×ª×•×£ ×¤×¢×•×œ×”, ×‘×¢×•×“ ×©'××ª×” ×¦×¨×™×š...' ×™×›×•×œ ×œ×”×™×©××¢ ×›×“×¨×™×©×”."}} },
                { type: 'lesson', title: {en: 'Positive Action Language', he: '×©×¤×ª ×¤×¢×•×œ×” ×—×™×•×‘×™×ª'}, content: {en: "It's more effective to ask for what we *do* want, rather than what we *don't* want. Our brains find it easier to do something than to not do something.", he: "×™×•×ª×¨ ×™×¢×™×œ ×œ×‘×§×© ××ª ××” ×©×× ×—× ×• *×›×Ÿ* ×¨×•×¦×™×, ×‘××§×•× ××ª ××” ×©×× ×—× ×• *×œ×* ×¨×•×¦×™×. ×œ××•×— ×©×œ× ×• ×§×œ ×™×•×ª×¨ ×œ×¢×©×•×ª ××©×”×• ×××©×¨ ×œ× ×œ×¢×©×•×ª ××©×”×•."}, example: {en: "Instead of: 'Please don't be late.'\nTry: 'Would you be willing to arrive by 8pm?'", he: "×‘××§×•×: '×‘×‘×§×©×” ××œ ×ª××—×¨.'\n× ×¡×•: '×”×× ×ª×”×™×” ××•×›×Ÿ ×œ×”×’×™×¢ ×¢×“ 20:00?'"} },
                { type: 'exercise', subType: 'ab-test', question: {en: "Which is a positive action request?", he: "××™×–×•×”×™ ×‘×§×©×” ×œ×¤×¢×•×œ×” ×—×™×•×‘×™×ª?"}, options: [{text: {en: 'Would you be willing to speak more quietly?', he: '×”×× ×ª×”×™×” ××•×›×Ÿ ×œ×“×‘×¨ ×‘×©×§×˜ ×™×•×ª×¨?'}, correct: true}, {text: {en: 'Can you stop shouting?', he: '××ª×” ×™×›×•×œ ×œ×”×¤×¡×™×§ ×œ×¦×¢×•×§?'}, correct: false}], feedback: {correct: {en: "Yes, you're asking for the action you want ('speak quietly') instead of the one you don't ('shouting').", he: "×›×Ÿ, ××ª× ××‘×§×©×™× ××ª ×”×¤×¢×•×œ×” ×©××ª× ×¨×•×¦×™× ('×œ×“×‘×¨ ×‘×©×§×˜') ×‘××§×•× ××ª ×–×• ×©××ª× ×œ× ×¨×•×¦×™× ('×œ×¦×¢×•×§')."}, incorrect: {en: "Asking someone to 'stop' an action is less effective than asking for the action you desire instead.", he: "×œ×‘×§×© ×××™×©×”×• '×œ×”×¤×¡×™×§' ×¤×¢×•×œ×” ×¤×—×•×ª ×™×¢×™×œ ××œ×‘×§×© ××ª ×”×¤×¢×•×œ×” ×”×¨×¦×•×™×” ×‘××§×•× ×–××ª."}} },
                { type: 'lesson', title: {en: 'The Full Path (OFNR)', he: '×”×©×‘×™×œ ×”××œ× (×”×‘×—× ×”, ×¨×’×©, ×¦×•×¨×š, ×‘×§×©×”)'}, content: {en: "Let's put it all together! Observation, Feeling, Need, Request.", he: "×‘×•××• × ×—×‘×¨ ×”×›×œ ×™×—×“! ×”×‘×—× ×”, ×¨×’×©, ×¦×•×¨×š, ×‘×§×©×”."}, example: {en: "'When I see the wet towel on the bed (O), I feel irritated (F), because I have a need for order in our shared space (N). Would you be willing to hang it in the bathroom (R)?'", he: "×›×©×× ×™ ×¨×•××” ××ª ×”××’×‘×ª ×”×¨×˜×•×‘×” ×¢×œ ×”××™×˜×” (×”), ×× ×™ ××¨×’×™×© ×¢×¦×‘× ×™ (×¨), ×›×™ ×™×© ×œ×™ ×¦×•×¨×š ×‘×¡×“×¨ ×‘××¨×—×‘ ×”××©×•×ª×£ ×©×œ× ×• (×¦). ×”×× ×ª×”×™×” ××•×›×Ÿ ×œ×ª×œ×•×ª ××•×ª×” ×‘×—×“×¨ ×”×××‘×˜×™×” (×‘)?'"} },
                { type: 'exercise', subType: 'mcq', question: {en: "What is the 'F' in the OFNR sequence?", he: "××”×™ ×”'×¨' ×‘×¨×¦×£ ×”×‘×—× ×”, ×¨×’×©, ×¦×•×¨×š, ×‘×§×©×”?"}, options: [{text: {en: 'Fact', he: '×¢×•×‘×“×” (Fact)'}, correct: false}, {text: {en: 'Feeling', he: '×¨×’×© (Feeling)'}, correct: true}, {text: {en: 'Fix', he: '×ª×™×§×•×Ÿ (Fix)'}, correct: false}], feedback: {correct: {en: "You got it! O-F-N-R stands for Observation, Feeling, Need, Request.", he: "×ª×¤×¡×ª ××ª ×–×”! ×”×¨×¦×£ ×”×•× ×”×‘×—× ×”, ×¨×’×©, ×¦×•×¨×š, ×‘×§×©×”."}, incorrect: {en: "The F is for Feeling. Remember: Observation, Feeling, Need, Request.", he: "×”-×¨' ×”×™× ×¢×‘×•×¨ ×¨×’×©. ×–×›×¨×•: ×”×‘×—× ×”, ×¨×’×©, ×¦×•×¨×š, ×‘×§×©×”."}} },
            ]},
        ];

        function saveData() { localStorage.setItem('nvcCourseProgress', JSON.stringify(state)); }
        function loadData() {
            const savedData = localStorage.getItem('nvcCourseProgress');
            if (savedData) {
                const parsed = JSON.parse(savedData);
                state = { ...defaultState, ...parsed };
            } else {
                state = { ...defaultState };
            }
        }
        function createButton(text, onClick, extraClass = '') { const btn = document.createElement('button'); btn.innerHTML = text; btn.className = `btn ${extraClass}`; btn.onclick = onClick; return btn; }
        
        function getTranslation(obj) {
            if (typeof obj !== 'object' || obj === null) {
                return obj;
            }
            return obj[state.lang] || obj['en'];
        }

        function updateUI() { 
            const t = getTranslation(courseContent);
            const totalModules = modules.length;
            let progressPercentage = totalModules > 0 ? (state.completedModules.length / totalModules) * 100 : 0;
            
            livesDisplay.style.display = 'none';
            
            if (state.view === 'stage') {
                const module = modules.find(s => s.id === state.activeModule.id);
                progressPercentage = module.screens.length > 0 ? (state.activeModule.screen / module.screens.length) * 100 : 0;
                livesDisplay.innerHTML = `â¤ï¸`.repeat(state.activeModule.lives);
                livesDisplay.style.display = 'block';
            }
            
            progressBar.style.width = `${progressPercentage}%`;
            xpDisplay.innerHTML = `ğŸ’– ${state.xp}`; 
            soundToggle.textContent = state.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            themeToggle.textContent = document.body.classList.contains('dark-mode') ? 'â˜€ï¸' : 'ğŸŒ™';
            document.body.dir = state.lang === 'he' ? 'rtl' : 'ltr';
            
            const giraffeIndex = Math.min(state.completedModules.length, giraffeSVGs.length - 1);
            giraffeSvgContainer.innerHTML = giraffeSVGs[giraffeIndex];
        }

        function render() {
            updateUI();
            contentArea.innerHTML = '';
            const view = state.view;
            if (view === 'map') renderMapView();
            else if (view === 'stage') renderModuleView();
            else if (view === 'moduleComplete') renderModuleCompleteScreen();
            else if (view === 'moduleFailed') renderModuleFailedScreen();
            else if (view === 'final') renderFinalScreen();
        }

        function renderMapView() {
            const t = getTranslation(courseContent);
            const mapView = document.createElement('div');
            mapView.className = 'map-view';
            mapView.innerHTML = `<h2 class="level-title">${t.level1Title}</h2>`;
            modules.forEach(moduleData => {
                const node = document.createElement('div');
                node.className = 'stage-node';
                const isCompleted = state.completedModules.includes(moduleData.id);
                const isUnlocked = state.completedModules.length + 1 === moduleData.id;
                const isLocked = !isCompleted && !isUnlocked;
                const button = document.createElement('button');
                button.className = 'stage-button';
                if(isCompleted) button.classList.add('completed');
                if(isUnlocked) button.classList.add('unlocked');
                if(isLocked) button.classList.add('locked');
                button.disabled = isLocked;
                button.innerHTML = `<div class="stage-icon">${isCompleted ? 'â­' : moduleData.icon}</div><div class="stage-title-map">${getTranslation(moduleData.title)}</div>`;
                button.onclick = () => { 
                    gtag('event', 'module_start', { 'module_id': moduleData.id });
                    state.view = 'stage'; 
                    state.activeModule = { id: moduleData.id, screen: 0, lives: 3 }; 
                    render(); 
                };
                if (isUnlocked) {
                    const botIcon = document.createElement('div');
                    botIcon.className = 'giraffe-map-icon';
                    const giraffeIndex = Math.min(state.completedModules.length, giraffeSVGs.length - 1);
                    botIcon.innerHTML = giraffeSVGs[giraffeIndex];
                    node.appendChild(botIcon);
                }
                node.appendChild(button);
                mapView.appendChild(node);
            });
            contentArea.appendChild(mapView);
            giraffeSpeech.textContent = t.mapSpeech;
        }

        function renderModuleView() {
            const t = getTranslation(courseContent);
            const module = modules.find(s => s.id === state.activeModule.id);
            if (!module) return;
            const screenData = module.screens[state.activeModule.screen];
            
            giraffeSpeech.textContent = t.stageSpeech;

            if (screenData.type === 'lesson') {
                const title = document.createElement('h1');
                title.className = 'screen-title';
                title.textContent = getTranslation(screenData.title);
                contentArea.appendChild(title);

                const content = document.createElement('p'); 
                content.className = 'lesson-content'; 
                content.innerHTML = getTranslation(screenData.content); 
                contentArea.appendChild(content);
                
                if (screenData.example) { 
                    const example = document.createElement('div'); 
                    example.className = 'lesson-example'; 
                    example.innerHTML = getTranslation(screenData.example).replace(/\n/g, '<br>'); 
                    contentArea.appendChild(example); 
                }
                
                const nextButton = createButton(t.continue, () => advanceScreen(), 'btn-primary');
                contentArea.appendChild(nextButton);
            } else if (screenData.type === 'exercise') {
                renderExerciseScreen(screenData);
            }
        }
        
        function advanceScreen() {
            const module = modules.find(s => s.id === state.activeModule.id);
            if (state.activeModule.screen < module.screens.length - 1) {
                state.activeModule.screen++; render();
            } else {
                state.view = 'moduleComplete';
                render();
            }
        }
        
        function completeModule() {
            if (!state.completedModules.includes(state.activeModule.id)) {
                gtag('event', 'module_complete', { 'module_id': state.activeModule.id });
                state.completedModules.push(state.activeModule.id);
                state.xp += 25;
            }
            if (state.completedModules.length === modules.length) {
                gtag('event', 'level_complete', { 'level_id': 1 });
                state.view = 'final';
            } else {
                state.view = 'map';
            }
            saveData();
            render();
        }

        function handleAnswer(button, isCorrect, feedbackData) {
            const t = getTranslation(courseContent);
            contentArea.querySelectorAll('button:not(.btn-primary)').forEach(b => b.disabled = true);
            const feedbackSection = document.createElement('div');
            const nextButtonContainer = document.createElement('div');
            feedbackSection.id = 'feedback-section';
            feedbackSection.innerHTML = `<div class="feedback-message"></div>`;
            nextButtonContainer.id = 'next-button-container';
            feedbackSection.appendChild(nextButtonContainer);
            const feedbackMessage = feedbackSection.querySelector('.feedback-message');
            
            const feedback = {
                correct: getTranslation(feedbackData.correct),
                incorrect: getTranslation(feedbackData.incorrect)
            };

            if (isCorrect) {
                playSound('correct');
                state.xp += 10;
                state.streak++;
                button.classList.add('correct');
                feedbackMessage.textContent = feedback.correct;
                feedbackMessage.className = 'feedback-message correct';
                if (state.streak >= 3) { giraffeSpeech.textContent = getTranslation({en: "You're connecting so well! âœ¨", he: "××ª× ××ª×—×‘×¨×™× ×›×œ ×›×š ×˜×•×‘! âœ¨"}); playSound('streak'); }
                else { giraffeSpeech.textContent = t.gotIt; }
                const nextButton = createButton(t.continue, () => advanceScreen(), 'btn-primary');
                nextButtonContainer.appendChild(nextButton);
            } else {
                gtag('event', 'answer_incorrect', { 'module_id': state.activeModule.id, 'screen_id': state.activeModule.screen });
                playSound('incorrect');
                state.streak = 0;
                state.activeModule.lives--;
                button.classList.add('incorrect');
                feedbackMessage.textContent = feedback.incorrect;
                feedbackMessage.className = 'feedback-message incorrect';
                giraffeSpeech.textContent = getTranslation({en: "That's a common mix-up. Let's look again.", he: "×–×” ×‘×œ×‘×•×œ × ×¤×•×¥. ×‘×•××• × × ×¡×” ×©×•×‘."});

                if (state.activeModule.lives <= 0) {
                    state.view = 'moduleFailed';
                    setTimeout(render, 1500);
                } else {
                    const retryButton = createButton(t.tryAgain, () => render());
                    nextButtonContainer.appendChild(retryButton);
                }
            }
            contentArea.appendChild(feedbackSection);
            saveData();
            updateUI();
        }
        
        function renderFinalScreen() {
            const t = getTranslation(courseContent);
            contentArea.innerHTML = '';
            const title = document.createElement('h1');
            title.className = 'completion-title';
            title.textContent = t.finalTitle;
            contentArea.appendChild(title);
            const content = document.createElement('p');
            content.className = 'lesson-content';
            content.textContent = t.finalContent;
            contentArea.appendChild(content);

            const completionActions = document.createElement('div');
            completionActions.className = 'completion-actions';
            
            const feedbackButton = createButton(t.feedbackCTA, () => window.open('https://forms.gle/V5ZWLzknQLtLNEUg8', '_blank'), 'btn-primary');
            completionActions.appendChild(feedbackButton);

            const resetButton = document.createElement('button');
            resetButton.id = 'reset-progress-btn';
            resetButton.textContent = t.resetProgress;
            resetButton.onclick = showResetConfirmModal;
            completionActions.appendChild(resetButton);

            contentArea.appendChild(completionActions);
            
            for(let i=0; i<100; i++) { const c = document.createElement('div'); c.className='confetti'; c.style.left=Math.random()*100+'vw'; c.style.animationDuration=Math.random()*2+3+'s'; c.style.backgroundColor=`hsl(${Math.random()*360},100%,50%)`; document.body.appendChild(c); setTimeout(() => { c.remove() }, 5000); }
            giraffeSpeech.textContent = t.finalBot;
        }

        function renderModuleCompleteScreen() {
            playSound('moduleComplete');
            const t = getTranslation(courseContent);
            contentArea.innerHTML = '';
            const icon = document.createElement('div');
            icon.className = 'completion-icon';
            icon.textContent = 'ğŸ‰';
            contentArea.appendChild(icon);
            const title = document.createElement('h2');
            title.className = 'completion-title';
            title.textContent = t.moduleComplete;
            contentArea.appendChild(title);

            const completionActions = document.createElement('div');
            completionActions.className = 'completion-actions';
            
            const continueButton = createButton(t.continueToMap, () => completeModule(), 'btn-primary');
            completionActions.appendChild(continueButton);
            
            // Add feedback button if it's the last module
            if (state.activeModule.id === modules.length) {
                 const feedbackButton = createButton(t.feedbackCTA, () => window.open('https://forms.gle/V5ZWLzknQLtLNEUg8', '_blank'));
                 completionActions.appendChild(feedbackButton);
            }

            const resetButton = document.createElement('button');
            resetButton.id = 'reset-progress-btn';
            resetButton.textContent = t.resetProgress;
            resetButton.onclick = showResetConfirmModal;
            completionActions.appendChild(resetButton);

            contentArea.appendChild(completionActions);
        }

        function renderModuleFailedScreen() {
            const t = getTranslation(courseContent);
            contentArea.innerHTML = '';
            const icon = document.createElement('div');
            icon.className = 'completion-icon';
            icon.textContent = 'ğŸŒ±';
            contentArea.appendChild(icon);
            const title = document.createElement('h2');
            title.className = 'completion-title';
            title.textContent = t.outOfTries;
            contentArea.appendChild(title);
            const content = document.createElement('p');
            content.className = 'lesson-content';
            content.textContent = t.outOfTriesMsg;
            contentArea.appendChild(content);
            const retryButton = createButton(t.tryAgain, () => {
                state.view = 'map'; render();
            }, 'btn-primary');
            contentArea.appendChild(retryButton);
        }

        function renderExerciseScreen(screenData) {
            // An exercise screen doesn't have its own title, it continues from the module title
            // So we find the module title to display
            const module = modules.find(m => m.id === state.activeModule.id);
            const title = document.createElement('h1');
            title.className = 'screen-title';
            title.textContent = getTranslation(module.title);
            contentArea.appendChild(title);
            
            const questionText = getTranslation(screenData.question);
            const question = document.createElement('p'); question.className = 'exercise-question'; question.textContent = questionText; contentArea.appendChild(question);
            const choiceContainer = document.createElement('div');
            switch(screenData.subType) {
                case 'mcq': case 'ab-test':
                    choiceContainer.className = 'choice-grid';
                    screenData.options.forEach(option => { 
                        const btn = createButton(getTranslation(option.text), () => handleAnswer(btn, option.correct, screenData.feedback));
                        choiceContainer.appendChild(btn);
                     });
                    break;
                case 'matching':
                     choiceContainer.className = 'matching-grid';
                     renderMatchingExercise(screenData, choiceContainer);
                     break;
            }
            contentArea.appendChild(choiceContainer);
        }

        function renderMatchingExercise(data, container) {
            const translatedPairs = data.pairs.map(p => ({
                item1: getTranslation(p.item1),
                item2: getTranslation(p.item2)
            }));
            const allItems = translatedPairs.flatMap(p => [p.item1, p.item2]);
            const shuffledItems = [...allItems].sort(() => Math.random() - 0.5);

            let selectedButton = null;
            let correctPairs = 0;

            const checkMatch = (clickedButton) => {
                if (!selectedButton) {
                    selectedButton = clickedButton;
                    selectedButton.classList.add('selected');
                    return;
                }
                if (selectedButton === clickedButton) { 
                    selectedButton.classList.remove('selected'); 
                    selectedButton = null; 
                    return; 
                }
                
                const val1 = selectedButton.textContent;
                const val2 = clickedButton.textContent;
                const isMatch = translatedPairs.some(p => (p.item1 === val1 && p.item2 === val2) || (p.item1 === val2 && p.item2 === val1));
                
                const btn1 = selectedButton;
                const btn2 = clickedButton;

                if (isMatch) {
                    playSound('correct');
                    [btn1, btn2].forEach(btn => {
                        if (btn) {
                            btn.classList.remove('selected'); 
                            btn.classList.add('correct'); 
                            btn.disabled = true; 
                        }
                    });
                    correctPairs++;
                    if (correctPairs === translatedPairs.length) { 
                        setTimeout(() => handleAnswer(container, true, data.feedback), 300); 
                    }
                } else {
                    playSound('incorrect');
                    [btn1, btn2].forEach(btn => {
                        if(btn) btn.classList.add('incorrect');
                    });
                    setTimeout(() => { 
                        [btn1, btn2].forEach(btn => {
                            if(btn) btn.classList.remove('incorrect', 'selected');
                        }); 
                    }, 800);
                }
                selectedButton = null;
            };

            shuffledItems.forEach(text => {
                const btn = createButton(text, () => checkMatch(btn), 'matching-pair');
                container.appendChild(btn);
            });
        }
        
        function setTheme(theme) {
            state.theme = theme;
            document.body.classList.toggle('dark-mode', theme === 'dark');
            saveData();
            updateUI();
        }
        
        function setLanguage(lang) {
            state.lang = lang;
            const t = getTranslation(courseContent);
            
            welcomeTitle.textContent = t.welcomeTitle;
            welcomeText.textContent = t.welcomeText;
            langSelectLabel.textContent = t.langSelectLabel;
            startCourseBtn.innerHTML = t.letsGo;
            supportLink.textContent = t.supportProject;
            termsLink.textContent = t.terms;
            privacyLink.textContent = t.privacy;
            cookieText.textContent = t.cookieText;
            acceptCookiesBtn.textContent = t.accept;
            declineCookiesBtn.textContent = t.decline;
            closePolicyBtn.textContent = t.close;
            resetConfirmTitle.textContent = t.resetConfirmTitle;
            resetConfirmText.textContent = t.resetConfirmText;
            confirmResetBtn.textContent = t.confirmReset;
            cancelResetBtn.textContent = t.cancel;


            langBtnEn.classList.toggle('active', lang === 'en');
            langBtnHe.classList.toggle('active', lang === 'he');

            document.body.dir = state.lang === 'he' ? 'rtl' : 'ltr';
            saveData();
        }

        function showPolicy(type) {
            const t = getTranslation(courseContent);
            const contactEmail = '10mvpsin20days@gmail.com';
            policyTitle.textContent = t[type];
            let policyContent = `<p>Last updated: June 13, 2024</p><p>For any questions, please contact us at <a href="mailto:${contactEmail}">${contactEmail}</a>.</p>`;
            if (type === 'privacy') {
                policyContent += `<p>We use Google Analytics to collect anonymous data about website usage to improve our service. This data is not personally identifiable. You can accept or decline this via the cookie consent banner. We do not sell or share your data with third parties.</p>`;
            } else {
                policyContent += `<p>By using this service, you agree to use it for educational purposes only. You agree not to reproduce or distribute the content without permission.</p>`;
            }
            policyText.innerHTML = policyContent;
            policyModalOverlay.style.display = 'flex';
        }

        function showResetConfirmModal() {
            resetConfirmModalOverlay.style.display = 'flex';
        }

        function resetProgress() {
            localStorage.removeItem('nvcCourseProgress');
            localStorage.removeItem('nvcCourseWelcomedV2');
            localStorage.removeItem('cookieConsent');
            location.reload();
        }

        function init() {
            loadData();
            setTheme(state.theme); 
            setLanguage(state.lang);
            
            supportLink.href = "https://revolut.me/yonatahf89";
            
            const cookieConsent = localStorage.getItem('cookieConsent');
            if (cookieConsent === 'true') {
                gtag('config', 'G-M27LTF4SQG');
            } else if (!cookieConsent) {
                cookieBanner.style.display = 'flex';
            }
            
            if (!localStorage.getItem('nvcCourseWelcomedV2')) {
                welcomeModalOverlay.style.display = 'flex';
            } else {
                render();
            }
            
            langBtnEn.addEventListener('click', () => setLanguage('en'));
            langBtnHe.addEventListener('click', () => setLanguage('he'));
            startCourseBtn.addEventListener('click', () => {
                welcomeModalOverlay.style.display = 'none';
                localStorage.setItem('nvcCourseWelcomedV2', 'true');
                saveData();
                render();
            });

            // Footer and Modal Listeners
            termsLink.addEventListener('click', (e) => { e.preventDefault(); showPolicy('terms'); });
            privacyLink.addEventListener('click', (e) => { e.preventDefault(); showPolicy('privacy'); });
            closePolicyBtn.addEventListener('click', () => { policyModalOverlay.style.display = 'none'; });

            // Cookie Listeners
            acceptCookiesBtn.addEventListener('click', () => {
                localStorage.setItem('cookieConsent', 'true');
                cookieBanner.style.display = 'none';
                gtag('config', 'G-M27LTF4SQG');
            });
            declineCookiesBtn.addEventListener('click', () => {
                localStorage.setItem('cookieConsent', 'false');
                cookieBanner.style.display = 'none';
            });
            
            // Reset Listeners
            confirmResetBtn.addEventListener('click', resetProgress);
            cancelResetBtn.addEventListener('click', () => { resetConfirmModalOverlay.style.display = 'none'; });

            // Other Listeners
            const firstInteraction = () => { initAudio(); document.body.removeEventListener('click', firstInteraction); document.body.removeEventListener('touchstart', firstInteraction); };
            document.body.addEventListener('click', firstInteraction);
            document.body.addEventListener('touchstart', firstInteraction);
            soundToggle.addEventListener('click', () => { initAudio(); state.isMuted = !state.isMuted; updateUI(); saveData(); });
            themeToggle.addEventListener('click', () => setTheme(state.theme === 'light' ? 'dark' : 'light'));
        }
        
        init();
    </script>
</body>
</html>
ï¿½
